<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cogitari Audit Tool v6.6 - UX Alignment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <!-- html2pdf.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page { margin: 0; box-shadow: none; width: 100%; padding: 10mm 15mm; }
            .finding-card { border: 1px solid #eee; break-inside: avoid; }
            #signatures-container { break-inside: avoid; }
            .tooltip-btn { display: none !important; }
            .tooltip-content { display: none !important; }
            .code-snippet { border: 1px solid #ccc; background-color: #f8fafc !important; color: #000 !important; }
            input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
            
            #github-connect-btn { display: none; }
            #github-connected-panel { display: block !important; border: none; background: transparent; padding: 0; }
            .github-print-hide { display: none; }
        }
        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 10mm auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #1a1a1a;
            position: relative;
        }
        input, textarea, select { border: none; border-bottom: 1px dotted #94a3b8; width: 100%; padding: 4px; font-family: inherit; background: transparent; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; background-color: #fff7ed; border-bottom: 2px solid #ea580c; }
        
        input[type="date"] { font-family: monospace; text-transform: uppercase; color: #475569; }
        .modal-input { border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; background-color: white; width: 100%; }
        
        .section-title { 
            border-left: 4px solid #ea580c; 
            padding-left: 10px; font-weight: bold; text-transform: uppercase; 
            font-size: 0.85rem; margin-bottom: 1.5rem; color: #9a3412;
            width: fit-content; display: flex; align-items: center;
        }

        /* Tooltips */
        .label-with-tooltip { display: flex; align-items: center; gap: 6px; margin-bottom: 0.5rem; }
        .tooltip-wrapper { position: relative; display: inline-flex; vertical-align: middle; }
        .tooltip-btn {
            width: 14px; height: 14px; border-radius: 50%; background-color: #cbd5e1;
            color: #475569; font-size: 9px; font-weight: bold; display: flex;
            align-items: center; justify-content: center; cursor: pointer; border: none;
            transition: all 0.2s; line-height: 0; flex-shrink: 0;
        }
        .tooltip-btn:hover, .tooltip-btn.active { background-color: #ea580c; color: white; }
        .tooltip-content {
            position: absolute; bottom: 140%; left: 50%; transform: translateX(-50%); width: 220px;
            background-color: #1e293b; color: white; padding: 8px 12px; border-radius: 6px;
            font-size: 11px; font-weight: normal; text-transform: none; text-align: center;
            line-height: 1.4; z-index: 9999; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
            pointer-events: none; opacity: 0; transition: opacity 0.2s, transform 0.2s;
            margin-bottom: 6px; display: none;
        }
        .tooltip-content.show { display: block; pointer-events: auto; opacity: 1; transform: translateX(-50%) translateY(0); }
        .tooltip-content::after {
            content: ''; position: absolute; top: 100%; left: 50%; margin-left: -5px;
            border-width: 5px; border-style: solid; border-color: #1e293b transparent transparent transparent;
        }

        .finding-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 2.5rem; background-color: #ffffff; position: relative; z-index: 10; }
        
        /* Badges */
        .select-badge input:checked + span.crítico { background-color: #ef4444; color: white; border-color: #ef4444; }
        .select-badge input:checked + span.alto { background-color: #f97316; color: white; border-color: #f97316; }
        .select-badge input:checked + span.médio { background-color: #eab308; color: white; border-color: #eab308; }
        .select-badge input:checked + span.baixo { background-color: #22c55e; color: white; border-color: #22c55e; }
        
        .select-badge input:checked + span.pendente { background-color: #64748b; color: white; border-color: #64748b; }
        .select-badge input:checked + span.andamento { background-color: #ea580c; color: white; border-color: #ea580c; }
        .select-badge input:checked + span.concluido { background-color: #10b981; color: white; border-color: #10b981; }
        .select-badge input:checked + span.bloqueado { background-color: #dc2626; color: white; border-color: #dc2626; }

        .select-badge input:checked + span.impact-active { background-color: #ea580c; color: white; border-color: #ea580c; }

        .badge-base {
            display: flex; align-items: center; justify-content: center;
            padding: 0.5rem 0; 
            border: 1px solid #e2e8f0; border-radius: 0.5rem; 
            font-size: 10px; font-weight: 700; text-transform: uppercase; 
            cursor: pointer; transition: all 0.2s; height: 100%; width: 100%;
            min-height: 34px;
        }
        .badge-base:hover { background-color: #fff7ed; border-color: #ea580c; color: #ea580c; }

        .image-preview { max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 4px; margin-top: 10px; border: 1px solid #e2e8f0; }
        .watermark { position: absolute; bottom: 30px; right: 30px; font-size: 8px; font-weight: 900; color: #f1f5f9; text-transform: uppercase; letter-spacing: 5px; pointer-events: none; user-select: none; z-index: 1; }
        
        #loading-modal, #auditor-modal, #signature-modal, #export-modal { display: none; }

        #save-toast {
            position: fixed; bottom: 20px; left: 20px; background: rgba(15, 23, 42, 0.9); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 10px; text-transform: uppercase;
            font-weight: bold; opacity: 0; transition: opacity 0.5s; pointer-events: none; z-index: 200;
            border-left: 3px solid #ea580c;
        }

        @keyframes pulse-border {
            0% { border-color: #e2e8f0; }
            50% { border-color: #ea580c; }
            100% { border-color: #e2e8f0; }
        }
        .connecting-github { animation: pulse-border 1.5s infinite; }
        
        /* Header UX */
        .header-btn { height: 36px; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .header-separator { width: 1px; height: 24px; background-color: #334155; margin: 0 4px; }
    </style>
</head>
<body class="bg-slate-100 p-4 pb-20" onclick="closeAllTooltips(event)">

    <div id="save-toast">Alterações salvas e assinadas</div>

    <!-- Barra de Ferramentas (UX Alinhado) -->
    <div class="no-print bg-slate-900 text-white p-4 mb-8 rounded-2xl max-w-7xl mx-auto shadow-2xl sticky top-4 z-[100] border-b-4 border-orange-600 flex flex-wrap gap-4 justify-between items-center">
        
        <!-- Grupo 1: Identidade e Contexto -->
        <div class="flex items-center gap-4 flex-1">
            <div class="bg-white p-1 rounded-lg h-10 w-10 flex items-center justify-center overflow-hidden border border-orange-500 shrink-0">
                <img src="logo-cogitari.png" alt="Logo" class="h-full w-full object-contain" onerror="this.style.display='none'; document.getElementById('fallback-logo').style.display='block'">
                <svg id="fallback-logo" style="display:none" xmlns="http://www.w3.org/2003/svg" viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            </div>
            
            <div class="hidden md:block shrink-0">
                <h1 class="font-bold text-lg leading-tight flex items-center gap-2">
                    Cogitari Audit
                    <span class="bg-orange-600 text-white text-[9px] px-2 py-0.5 rounded-full uppercase tracking-widest">v6.6</span>
                </h1>
                <p class="text-[9px] uppercase tracking-widest opacity-60 italic">Compliance Engine</p>
            </div>

            <!-- Seletor de Auditor (Integrado) -->
            <div class="flex items-center gap-2 bg-slate-800/80 px-3 py-1 rounded-lg border border-slate-700 ml-4">
                <svg xmlns="http://www.w3.org/2003/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-500"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                <div class="flex flex-col">
                    <span class="text-[8px] font-bold text-slate-400 uppercase leading-none">Auditor Ativo</span>
                    <select id="active-auditor-selector" class="bg-transparent text-white text-xs font-bold border-none focus:ring-0 cursor-pointer p-0 h-4 w-32" onchange="/* Context switch */">
                        <!-- JS -->
                    </select>
                </div>
            </div>
        </div>

        <!-- Grupo 2: Ações -->
        <div class="flex items-center gap-2">
            
            <!-- Dev Tools -->
            <button onclick="fillTestMode()" class="header-btn bg-slate-800 text-slate-300 hover:text-white px-3 rounded-lg text-xs font-bold border border-slate-700 hover:border-purple-500" title="Preencher Dados de Teste">
                <svg xmlns="http://www.w3.org/2003/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                <span class="hidden lg:inline ml-2">Teste</span>
            </button>
            <button onclick="clearDraft()" class="header-btn bg-slate-800 text-slate-300 hover:text-red-300 px-3 rounded-lg text-xs font-bold border border-slate-700 hover:border-red-900" title="Limpar Rascunho">
                <svg xmlns="http://www.w3.org/2003/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>

            <div class="header-separator"></div>

            <!-- Operational Tools -->
            <button onclick="toggleAuditorModal(true)" class="header-btn bg-slate-700 hover:bg-slate-600 text-white px-3 rounded-lg text-xs font-bold border border-slate-600 shadow-sm" title="Gerenciar Equipe">
                <svg xmlns="http://www.w3.org/2003/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                <span class="hidden sm:inline ml-2">Equipe</span>
            </button>
            <button onclick="addFinding(true)" class="header-btn bg-orange-600 hover:bg-orange-500 text-white px-4 rounded-lg text-xs font-bold shadow-md hover:shadow-orange-900/20">
                <svg xmlns="http://www.w3.org/2003/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                Novo Achado
            </button>

            <div class="header-separator"></div>

            <!-- Export Tools -->
            <div class="flex bg-slate-800 rounded-lg p-1 border border-slate-700">
                <button onclick="handleDriveSave()" class="header-btn h-7 px-3 hover:bg-slate-700 rounded text-xs font-bold text-slate-300 hover:text-white" title="Salvar no Drive">
                    <svg xmlns="http://www.w3.org/2003/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
                </button>
                <div class="w-px bg-slate-700 my-1"></div>
                <button onclick="openExportModal()" class="header-btn h-7 px-3 bg-white text-slate-900 hover:bg-orange-50 rounded text-xs font-bold shadow-sm" title="Exportar Relatório">
                    <span class="mr-1">Salvar</span>
                    <svg xmlns="http://www.w3.org/2003/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Exportação -->
    <div id="export-modal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-md w-full shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b-4 border-orange-600">
                <h3 class="font-bold text-sm uppercase tracking-wider">Escolha o Formato</h3>
                <button onclick="toggleExportModal(false)" class="hover:text-orange-400">✕</button>
            </div>
            <div class="p-6 space-y-4">
                <p class="text-xs text-slate-500 mb-2">Selecione como deseja salvar seu relatório. <br><strong>Regra de Compliance:</strong> O relatório só pode ser gerado na data Fim (Segunda-feira) e com todas as assinaturas atualizadas.</p>
                <button onclick="exportFile('pdf')" class="w-full flex items-center justify-between p-4 border border-orange-200 bg-orange-50 rounded-xl hover:bg-orange-100 transition-colors group">
                    <div class="flex items-center gap-3"><div class="bg-red-500 text-white p-2 rounded-lg">PDF</div><div class="text-left"><p class="font-bold text-slate-900 text-sm">PDF (Recomendado)</p></div></div>
                    <span class="text-slate-400 group-hover:text-orange-600">➔</span>
                </button>
                <button onclick="exportFile('docx')" class="w-full flex items-center justify-between p-4 border border-slate-200 bg-white rounded-xl hover:bg-slate-50 transition-colors group">
                    <div class="flex items-center gap-3"><div class="bg-blue-600 text-white p-2 rounded-lg">DOC</div><div class="text-left"><p class="font-bold text-slate-900 text-sm">DOCX (Editável)</p></div></div>
                    <span class="text-slate-400 group-hover:text-blue-600">➔</span>
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="exportFile('txt')" class="p-3 border border-slate-200 rounded-lg hover:bg-slate-50 text-xs font-bold text-slate-600">TXT</button>
                    <button onclick="exportFile('json')" class="p-3 border border-slate-200 rounded-lg hover:bg-slate-50 text-xs font-bold text-slate-600">JSON</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais de Apoio -->
    <div id="auditor-modal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b-4 border-orange-600">
                <h3 class="font-bold text-sm uppercase tracking-wider">Gestão de Equipe</h3>
                <button onclick="toggleAuditorModal(false)" class="hover:text-orange-400">✕</button>
            </div>
            <div class="p-6">
                <div class="flex gap-2 mb-4"><input type="text" id="new-auditor-name" class="modal-input flex-1 text-sm" placeholder="Nome (ex: David QA)"><button onclick="addAuditor()" class="bg-orange-600 text-white px-4 rounded-lg font-bold text-lg hover:bg-orange-700">+</button></div>
                <div class="text-[10px] uppercase font-bold text-slate-400 mb-2">Auditores Disponíveis:</div>
                <ul id="auditor-list" class="space-y-2 max-h-48 overflow-y-auto"></ul>
            </div>
            <div class="bg-slate-50 p-4 text-center"><button onclick="toggleAuditorModal(false)" class="text-orange-600 text-xs font-bold uppercase hover:underline">Salvar e Fechar</button></div>
        </div>
    </div>

    <div id="signature-modal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b-4 border-orange-600">
                <h3 class="font-bold text-sm uppercase tracking-wider">Dados da Assinatura</h3>
                <button onclick="toggleSignatureModal(false)" class="hover:text-orange-400">✕</button>
            </div>
            <div class="p-6 space-y-4">
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome</label><input type="text" id="signer-name" class="modal-input"></div>
                <div><label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cargo</label><input type="text" id="signer-role" class="modal-input"></div>
            </div>
            <div class="bg-slate-50 p-4 text-center"><button onclick="confirmSignature()" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-orange-700 w-full">Confirmar</button></div>
        </div>
    </div>

    <div id="loading-modal" class="fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <div id="loader-icon" class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
            <h3 id="status-title" class="font-bold text-lg mb-2 text-slate-800">Sincronizando...</h3>
            <p id="status-desc" class="text-sm text-slate-500 mb-6">Processando.</p>
            <button id="close-modal-btn" onclick="toggleModal(false)" class="hidden bg-slate-900 text-white px-6 py-2 rounded-xl font-bold text-sm w-full">Entendido</button>
        </div>
    </div>

    <div id="report-content">
        <div class="page" id="main-page">
            <div class="flex justify-between items-start mb-8 border-b-2 border-slate-900 pb-6">
                <div class="flex items-center gap-4">
                    <div class="h-16 w-16 bg-white border border-slate-200 rounded-xl flex items-center justify-center p-1 overflow-hidden shadow-sm">
                        <!-- LOGO COGITARI -->
                        <img src="logo-cogitari.png" alt="Logo" class="w-full h-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                        <svg style="display:none" xmlns="http://www.w3.org/2003/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black uppercase tracking-tighter text-slate-900">Relatório de Auditoria</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="h-1 w-8 bg-orange-600"></div>
                            <p class="text-xs font-bold uppercase tracking-widest text-slate-500">Cogitari Tech</p>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Documento ID</div>
                    <input type="text" id="doc-id" value="CGT-2026-AUD-001" class="text-sm font-mono font-bold text-slate-600 text-right bg-transparent border-none p-0 focus:bg-transparent" onchange="registerAction()">
                </div>
            </div>

            <!-- Dados da Empresa com Tooltips -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <div class="space-y-4">
                    <div>
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-slate-400 uppercase block">Empresa Cliente</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Nome jurídico ou fantasia do cliente/parceiro auditado.</div></div>
                        </div>
                        <input type="text" id="client-name" placeholder="Ex: Amuri SaaS" onchange="registerAction()">
                    </div>
                    
                    <div>
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-slate-400 uppercase block">Projeto / Módulo</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Produto, microsserviço ou subsistema específico sob análise.</div></div>
                        </div>
                        <input type="text" id="project-name" placeholder="Ex: Módulo de Vídeo IA" onchange="registerAction()">
                    </div>
                    
                    <div>
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-slate-400 uppercase block">Ambiente</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Ambiente técnico onde a auditoria foi realizada (Produção, Staging, Local, etc.).</div></div>
                        </div>
                        <input type="text" id="env-name" placeholder="Ex: Produção / Vercel" onchange="registerAction()">
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="label-with-tooltip">
                                <label class="text-[10px] font-black text-slate-400 uppercase block">Início</label>
                                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Data de início das atividades de auditoria.</div></div>
                            </div>
                            <input type="date" id="start-date" onchange="registerAction()">
                        </div>
                        <div>
                            <div class="label-with-tooltip">
                                <label class="text-[10px] font-black text-slate-400 uppercase block">Fim</label>
                                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Data prevista ou real de finalização do relatório (Obrigatório: Segunda-feira).</div></div>
                            </div>
                            <input type="date" id="end-date" onchange="validateMonday(this); registerAction()">
                        </div>
                    </div>
                    <div>
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-slate-400 uppercase block">Auditor Líder (Ref.)</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Profissional responsável pela validação final deste documento.</div></div>
                        </div>
                        <select id="lead-auditor" class="auditor-select-global w-full text-sm font-medium" onchange="registerAction()">
                            <option>Maurício Caique (CTO)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- NOVA SEÇÃO: GITHUB INTEGRATION MOCKUP -->
            <div class="mb-10 bg-slate-50 border border-slate-200 rounded-xl p-4 relative group hover:border-orange-200 transition-all duration-300">
                <div class="absolute top-0 right-0 bg-slate-200 text-slate-500 text-[9px] font-bold px-2 py-1 rounded-bl-lg uppercase tracking-widest group-hover:bg-orange-600 group-hover:text-white transition-colors cursor-help" title="Funcionalidade em desenvolvimento">
                    Beta
                </div>
                
                <div class="flex items-center gap-2 mb-3">
                    <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round" class="text-slate-700"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
                    <div class="label-with-tooltip mb-0">
                        <h4 class="text-xs font-bold text-slate-700 uppercase tracking-wider">Fonte da Auditoria (GitHub)</h4>
                        <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Integração direta com repositórios para puxar contexto de código e versionamento.</div></div>
                    </div>
                </div>

                <div id="github-connect-view" class="flex justify-center py-4">
                    <button id="github-connect-btn" onclick="simulateGithubLogin(this)" class="bg-slate-800 hover:bg-black text-white text-xs font-bold px-5 py-2 rounded-lg flex items-center gap-2 transition-all">
                        <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>
                        Conectar Repositório
                    </button>
                </div>

                <div id="github-connected-panel" class="hidden animate-in fade-in slide-in-from-bottom-2 duration-500">
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-[9px] font-bold text-slate-500 uppercase mb-1">Organização</label>
                            <select class="modal-input text-xs h-8 py-0 bg-white"><option>cogitari-tech</option><option>amuri-labs</option></select>
                        </div>
                        <div>
                            <label class="block text-[9px] font-bold text-slate-500 uppercase mb-1">Repositório</label>
                            <select class="modal-input text-xs h-8 py-0 bg-white"><option>amuri-saas-platform</option><option>audit-tool</option><option>landing-page-v2</option></select>
                        </div>
                        <div class="flex items-end gap-2">
                            <div class="flex-1">
                                <label class="block text-[9px] font-bold text-slate-500 uppercase mb-1">Branch / Commit</label>
                                <div class="flex items-center gap-1 bg-white border border-slate-200 rounded px-2 h-8">
                                    <svg viewBox="0 0 24 24" width="10" height="10" stroke="currentColor" stroke-width="2" fill="none" class="text-orange-600"><line x1="6" y1="3" x2="6" y2="15"></line><circle cx="18" cy="6" r="3"></circle><circle cx="6" cy="18" r="3"></circle><path d="M18 9a9 9 0 0 1-9 9"></path></svg>
                                    <span class="text-xs font-mono">main</span>
                                </div>
                            </div>
                            <button onclick="disconnectGithub()" class="github-print-hide text-red-500 hover:text-red-700 text-[10px] font-bold uppercase mb-1.5" title="Desconectar">✕</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Título com Tooltip -->
            <div class="section-title">
                1. Sumário Executivo
                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Visão geral gerencial dos resultados da auditoria, destacando pontos críticos para a diretoria.</div></div>
            </div>
            <textarea id="summary-text" rows="4" class="text-sm w-full p-4 bg-slate-50 rounded-xl mb-12 border border-slate-100 focus:bg-orange-50" placeholder="Resumo dos achados principais..." oninput="registerAction()"></textarea>

            <!-- Título com Tooltip -->
            <div class="section-title">
                2. Registro de Ocorrências Técnicas
                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Lista detalhada de todas as não conformidades, bugs ou melhorias identificadas.</div></div>
            </div>
            <div id="findings-container"></div>
            
            <div class="no-print flex justify-center py-6">
                <button onclick="addFinding(true)" class="group flex items-center gap-3 bg-slate-100 hover:bg-orange-600 hover:text-white px-8 py-4 rounded-2xl transition-all duration-300 border-2 border-dashed border-slate-300 hover:border-orange-600">
                    <span class="bg-orange-600 text-white p-1 rounded-full group-hover:bg-white group-hover:text-orange-600">
                        <svg xmlns="http://www.w3.org/2003/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </span>
                    <span class="font-bold uppercase text-xs tracking-widest">Adicionar Outra Ocorrência</span>
                </button>
            </div>

            <div class="watermark">Cogitari Tech</div>
        </div>

        <div class="page">
            <div class="section-title">
                3. Parecer Final
                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Conclusão final do auditor, incluindo recomendação de aprovação ou reprovação do ambiente.</div></div>
            </div>
            <textarea id="final-opinion" rows="15" class="text-sm w-full p-6 bg-slate-50 rounded-2xl mb-12 focus:bg-orange-50" placeholder="Conclusão da auditoria..." oninput="registerAction()"></textarea>

            <div class="section-title mb-8">
                4. Assinaturas e Responsabilidade Técnica
                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Registro imutável dos responsáveis e datas de modificação do documento.</div></div>
            </div>
            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 min-h-[150px] relative">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-6 text-center">Registro de Modificações e Responsáveis</p>
                <div id="signatures-container" class="grid grid-cols-2 gap-x-12 gap-y-12"></div>
                <div class="no-print absolute bottom-4 right-4">
                    <button onclick="openSignatureModal()" class="bg-slate-800 text-white text-[10px] uppercase font-bold px-3 py-1.5 rounded hover:bg-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2003/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Assinar Agora
                    </button>
                </div>
            </div>
            <div class="watermark">Cogitari Tech</div>
        </div>
    </div>

    <script>
        // CONFIG
        const CLIENT_ID = ''; 
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';
        const STORAGE_KEY = 'cogitari_audit_autosave';

        let tokenClient;
        let accessToken = null;
        let auditors = ['Maurício Caique'];
        let activeSignatures = {}; 
        let findingCount = 0;
        let saveTimeout;
        let unsavedChanges = false;

        window.onload = function() {
            initGoogleDrive();
            if(localStorage.getItem(STORAGE_KEY)) loadLocal();
            else { renderAuditorList(); updateAuditorSelects(); addFinding(false, false); renderSignatures(); }
        };

        // --- GITHUB MOCKUP LOGIC ---
        function simulateGithubLogin(btn) {
            const originalText = btn.innerHTML;
            btn.innerHTML = `<svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2003/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Autenticando...`;
            btn.disabled = true;
            setTimeout(() => {
                document.getElementById('github-connect-view').classList.add('hidden');
                document.getElementById('github-connected-panel').classList.remove('hidden');
                btn.innerHTML = originalText;
                btn.disabled = false;
                registerAction(); 
            }, 1500);
        }

        function disconnectGithub() {
            if(confirm("Desconectar repositório?")) {
                document.getElementById('github-connected-panel').classList.add('hidden');
                document.getElementById('github-connect-view').classList.remove('hidden');
                registerAction();
            }
        }

        // --- PROTEÇÃO AO FECHAR ---
        window.addEventListener('beforeunload', function (e) {
            if (unsavedChanges) {
                e.preventDefault();
                e.returnValue = 'Você tem alterações não salvas ou não assinadas. Deseja sair?';
            }
        });

        // --- VALIDAÇÃO SEGUNDA-FEIRA ---
        function validateMonday(input) {
            if(!input.value) return;
            const date = new Date(input.value);
            const day = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate()).getDay();
            if(day !== 1) { 
                alert("POLÍTICA DE COMPLIANCE:\nA data final da auditoria deve ser obrigatoriamente uma SEGUNDA-FEIRA.");
                input.value = "";
                registerAction();
            }
        }

        // --- MODO DE TESTE ---
        function fillTestMode() {
            const today = new Date();
            let nextMonday = new Date(today);
            if (today.getDay() !== 1) {
                nextMonday.setDate(today.getDate() + ((1 + 7 - today.getDay()) % 7));
            }
            
            document.getElementById('client-name').value = "ACME Corp (Teste)";
            document.getElementById('project-name').value = "Projeto Alpha";
            document.getElementById('env-name').value = "Staging";
            document.getElementById('start-date').valueAsDate = new Date();
            document.getElementById('end-date').valueAsDate = nextMonday;
            document.getElementById('summary-text').value = "Este é um resumo executivo gerado automaticamente para fins de teste e validação de layout.";
            document.getElementById('final-opinion').value = "O ambiente encontra-se em conformidade parcial, aguardando correções de nível médio.";
            
            if(findingCount === 0) addFinding(true, true); 
            const desc = document.querySelector('textarea[placeholder^="Detalhes"]');
            if(desc) desc.value = "Erro simulado na API de login.";
            
            registerAction();
            alert("Modo de Teste Ativado.\nDados preenchidos para validação.");
        }

        // --- TOOLTIP LOGIC ---
        function toggleTooltip(event, btn) {
            event.stopPropagation();
            document.querySelectorAll('.tooltip-content.show').forEach(el => {
                if(el !== btn.nextElementSibling) el.classList.remove('show');
            });
            const content = btn.nextElementSibling;
            content.classList.toggle('show');
        }

        function closeAllTooltips(event) {
            if(!event.target.classList.contains('tooltip-btn')) {
                document.querySelectorAll('.tooltip-content.show').forEach(el => el.classList.remove('show'));
            }
        }

        // --- EXPORTAÇÃO ---
        function openExportModal() {
            if (Object.keys(activeSignatures).length === 0) {
                alert("BLOQUEIO DE SEGURANÇA:\nO relatório está sem assinaturas. Edite um campo ou assine manualmente.");
                return;
            }

            const endDateVal = document.getElementById('end-date').value;
            if(!endDateVal) {
                alert("ERRO:\nDefina a data FIM da auditoria.");
                return;
            }

            const todayStr = new Date().toISOString().split('T')[0];
            if(endDateVal !== todayStr) {
                 const confirmGen = confirm(`ATENÇÃO DE COMPLIANCE:\nA data FIM definida (${endDateVal}) não coincide com a data de hoje (${todayStr}).\n\nEm produção, isso bloquearia a geração.\nDeseja forçar a geração para fins de teste?`);
                 if(!confirmGen) return;
            }

            document.getElementById('export-modal').style.display = 'flex';
        }
        function toggleExportModal(show) { document.getElementById('export-modal').style.display = show ? 'flex' : 'none'; }

        function exportFile(type) {
            toggleExportModal(false);
            const clientName = document.getElementById('client-name').value || "Cliente";
            const date = new Date().toISOString().split('T')[0];
            const baseName = `Auditoria_${clientName.replace(/\s/g, '_')}_${date}`;
            unsavedChanges = false;

            if(type === 'pdf') generateAndDownloadPDF();
            else if(type === 'docx') exportDocx(baseName);
            else if(type === 'txt') exportTxt(baseName);
            else if(type === 'json') exportJson(baseName);
        }

        function exportDocx(filename) {
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Export HTML To Doc</title></head><body>";
            const footer = "</body></html>";
            const sourceHTML = header + document.getElementById("report-content").innerHTML + footer;
            const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
            const fileDownload = document.createElement("a");
            document.body.appendChild(fileDownload);
            fileDownload.href = source;
            fileDownload.download = filename + '.doc';
            fileDownload.click();
            document.body.removeChild(fileDownload);
        }

        function exportTxt(filename) {
            let content = `RELATÓRIO DE AUDITORIA - COGITARI TECH\n\n`;
            content += `CLIENTE: ${document.getElementById('client-name').value}\n`;
            content += `PROJETO: ${document.getElementById('project-name').value}\n`;
            content += `ID: ${document.getElementById('doc-id').value}\n`;
            content += `SUMÁRIO: ${document.getElementById('summary-text').value}\n\n`;
            content += `--- ACHADOS ---\n`;
            const cards = document.querySelectorAll('.finding-card');
            cards.forEach((c, i) => {
                content += `\n#${i+1} - ${c.querySelector('textarea').value}\n`;
                content += `Recomendação: ${c.querySelectorAll('textarea')[1].value}\n`;
            });
            const blob = new Blob([content], { type: 'text/plain' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.txt';
            link.click();
        }

        function exportJson(filename) {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename + '.json';
            link.click();
        }

        // --- AUTO SAVE ---
        function saveState() {
            unsavedChanges = true; 
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                const data = {
                    auditors, activeSignatures, findingCount,
                    globals: {
                        'doc-id': document.getElementById('doc-id').value,
                        'client-name': document.getElementById('client-name').value,
                        'project-name': document.getElementById('project-name').value, 
                        'env-name': document.getElementById('env-name').value,
                        'start-date': document.getElementById('start-date').value,
                        'end-date': document.getElementById('end-date').value,
                        'lead-auditor': document.getElementById('lead-auditor').value,
                        'summary-text': document.getElementById('summary-text').value,
                        'final-opinion': document.getElementById('final-opinion').value,
                    },
                    findings: []
                };
                const cards = document.querySelectorAll('.finding-card');
                cards.forEach((card, idx) => {
                    const id = idx + 1;
                    const desc = card.querySelector('textarea[placeholder^="Detalhes"]').value;
                    const rec = card.querySelector('textarea[placeholder^="Ação"]').value;
                    const code = card.querySelector('.code-snippet').value; 
                    const taskType = card.querySelector('.task-type-select').value; 
                    const riskEl = card.querySelector(`input[name="risk-${id}"]:checked`);
                    const riskClass = riskEl ? riskEl.nextElementSibling.classList[0] : null;
                    const impacts = []; card.querySelectorAll('.select-badge.impact-badge input:checked').forEach(cb => impacts.push(cb.nextElementSibling.innerText)); 
                    const statusEl = card.querySelector(`input[name="status-${id}"]:checked`);
                    const statusClass = statusEl ? statusEl.nextElementSibling.classList[0] : null;
                    const links = []; card.querySelectorAll('.links-list div input').forEach(inp => { if(inp.value) links.push(inp.value); });
                    const email = card.querySelector('.email-notification').value;
                    const notify = card.querySelector('.notify-checkbox').checked;
                    data.findings.push({ desc, rec, code, taskType, riskClass, impacts, statusClass, links, email, notify });
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                showToast();
            }, 500);
        }

        function loadLocal() {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY));
            auditors = data.auditors || ['Maurício Caique'];
            activeSignatures = data.activeSignatures || {};
            renderAuditorList(); updateAuditorSelects(); renderSignatures();
            for (const [key, val] of Object.entries(data.globals)) { const el = document.getElementById(key); if(el) el.value = val; }
            document.getElementById('findings-container').innerHTML = '';
            findingCount = 0;
            if(data.findings && data.findings.length > 0) {
                data.findings.forEach(f => {
                    addFinding(false, false); // No register
                    const id = findingCount; const card = document.querySelectorAll('.finding-card')[id-1];
                    card.querySelector('textarea[placeholder^="Detalhes"]').value = f.desc;
                    card.querySelector('textarea[placeholder^="Ação"]').value = f.rec;
                    if(f.code) card.querySelector('.code-snippet').value = f.code; 
                    if(f.taskType) card.querySelector('.task-type-select').value = f.taskType; 
                    if(f.riskClass) { const span = card.querySelector(`.select-badge span.${f.riskClass}`); if(span) span.previousElementSibling.checked = true; }
                    if(f.impacts) { const spans = card.querySelectorAll('.select-badge.impact-badge span'); spans.forEach(sp => { if(f.impacts.includes(sp.innerText)) sp.previousElementSibling.checked = true; }); }
                    if(f.statusClass) { const span = card.querySelector(`.select-badge span.${f.statusClass}`); if(span) span.previousElementSibling.checked = true; }
                    if(f.links) { const btn = card.querySelector('button[onclick^="addLinkRow"]'); f.links.forEach(url => { addLinkRow(btn); const inputs = card.querySelectorAll('.links-list div input'); inputs[inputs.length-1].value = url; }); }
                    if(f.email) card.querySelector('.email-notification').value = f.email;
                    if(f.notify) { card.querySelector('.notify-checkbox').checked = true; toggleEmailInput(card.querySelector('.notify-checkbox')); }
                });
            } else { addFinding(false, false); }
        }

        function clearDraft() {
            if(confirm("Tem certeza? Isso apagará todos os dados não salvos.")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }
        }
        function showToast() { const t = document.getElementById('save-toast'); t.style.opacity = 1; setTimeout(() => t.style.opacity = 0, 2000); }

        // --- TRACEABILITY ---
        function registerAction(roleOverride = null) {
            saveState(); 
            const activeAuditor = document.getElementById('active-auditor-selector').value;
            if (!activeAuditor) return;
            const timestamp = new Date().toLocaleString('pt-BR');
            let currentRole = activeSignatures[activeAuditor]?.role || "Auditor Técnico";
            if (roleOverride) currentRole = roleOverride;
            activeSignatures[activeAuditor] = { date: timestamp, role: currentRole };
            renderSignatures();
        }

        // --- MODAL ASSINATURA ---
        function openSignatureModal() {
            const activeAuditor = document.getElementById('active-auditor-selector').value;
            document.getElementById('signer-name').value = activeAuditor;
            document.getElementById('signer-role').value = activeSignatures[activeAuditor]?.role || "";
            document.getElementById('signature-modal').style.display = 'flex';
        }
        function toggleSignatureModal(show) { document.getElementById('signature-modal').style.display = show ? 'flex' : 'none'; }
        
        function confirmSignature() {
            const name = document.getElementById('signer-name').value;
            const role = document.getElementById('signer-role').value;
            if(!name || !role) { alert("Preencha tudo."); return; }
            if(!auditors.includes(name)) { auditors.push(name); renderAuditorList(); updateAuditorSelects(); document.getElementById('active-auditor-selector').value = name; }
            const timestamp = new Date().toLocaleString('pt-BR');
            activeSignatures[name] = { date: timestamp, role: role };
            renderSignatures(); saveState(); toggleSignatureModal(false);
        }

        function renderSignatures() {
            const container = document.getElementById('signatures-container');
            const signers = Object.keys(activeSignatures);
            if (signers.length === 0) { container.innerHTML = `<div class="col-span-2 text-center text-slate-400 italic text-xs py-8">Aguardando início da auditoria...<br>(Edite o documento ou clique no botão abaixo para assinar)</div>`; return; }
            container.innerHTML = signers.map(auditor => `
                <div class="border-t-2 border-slate-900 pt-3 animate-in fade-in slide-in-from-bottom-2">
                    <p class="text-[11px] font-black uppercase text-slate-900">${auditor}</p>
                    <p class="text-[10px] text-slate-600 font-bold uppercase mb-1">${activeSignatures[auditor].role}</p>
                    <div class="flex justify-between items-end mt-1">
                        <div class="flex items-center gap-1 text-green-600"><svg xmlns="http://www.w3.org/2003/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg><p class="text-[9px] font-bold uppercase">Verificado</p></div>
                        <p class="text-[9px] text-slate-400 text-right">Última Ação:<br>${activeSignatures[auditor].date}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- PDF (Mantido apenas como função de apoio ao botão "Salvar") ---
        function validateAndPrint() {
            if (Object.keys(activeSignatures).length === 0) { alert("Sem assinaturas."); return; }
            generateAndDownloadPDF();
        }
        function generateAndDownloadPDF() {
            toggleModal(true, "Gerando PDF...", "Aguarde...");
            const element = document.getElementById('report-content');
            const clientName = document.getElementById('client-name').value || "Cliente";
            const date = new Date().toISOString().split('T')[0];
            const fileName = `Auditoria_${clientName.replace(/\s/g, '_')}_${date}.pdf`;
            const noPrint = document.querySelectorAll('.no-print');
            noPrint.forEach(el => el.style.display = 'none');
            const opt = { margin: 0, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };
            html2pdf().from(element).set(opt).save().then(() => { noPrint.forEach(el => el.style.display = ''); toggleModal(false); }).catch(() => { toggleModal(false); alert("Erro."); });
        }

        // --- AUDITORS ---
        function toggleAuditorModal(show) { document.getElementById('auditor-modal').style.display = show ? 'flex' : 'none'; }
        function addAuditor() { const name = document.getElementById('new-auditor-name').value.trim(); if (name && !auditors.includes(name)) { auditors.push(name); document.getElementById('new-auditor-name').value = ''; renderAuditorList(); updateAuditorSelects(); saveState(); } }
        function removeAuditor(index) { if(confirm('Remover?')) { delete activeSignatures[auditors[index]]; auditors.splice(index, 1); renderAuditorList(); updateAuditorSelects(); renderSignatures(); saveState(); } }
        function renderAuditorList() { document.getElementById('auditor-list').innerHTML = auditors.map((aud, index) => `<li class="flex justify-between items-center bg-slate-100 p-2 rounded text-sm border border-slate-200"><span class="font-bold text-slate-700">${aud}</span><button onclick="removeAuditor(${index})" class="text-red-500 font-bold hover:text-red-700">×</button></li>`).join(''); }
        function updateAuditorSelects() {
            const activeSelect = document.getElementById('active-auditor-selector'); const current = activeSelect.value;
            activeSelect.innerHTML = auditors.map(aud => `<option value="${aud}">${aud}</option>`).join(''); if(auditors.includes(current)) activeSelect.value = current;
            const leadSelect = document.getElementById('lead-auditor'); const currentLead = leadSelect.value;
            leadSelect.innerHTML = auditors.map(aud => `<option value="${aud}">${aud}</option>`).join(''); if(auditors.includes(currentLead)) leadSelect.value = currentLead;
        }

        // --- ACHADOS ---
        function addFinding(shouldRegister = true, isTest = false) {
            findingCount++; if (shouldRegister) registerAction();
            const container = document.getElementById('findings-container'); const div = document.createElement('div');
            div.className = 'finding-card border-l-8 border-l-slate-800 animate-in fade-in slide-in-from-top-4 duration-300';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4"><span class="bg-slate-800 text-white px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest">Achado #0${findingCount}</span></div>
                    <button onclick="this.closest('.finding-card').remove(); registerAction();" class="no-print text-red-500 hover:text-red-700 text-[10px] font-bold uppercase">Excluir</button>
                </div>
                <div class="space-y-6">
                    <div class="grid grid-cols-3 gap-4">
                        <div class="col-span-2">
                            <label class="text-[10px] font-black text-slate-500 uppercase block mb-2">Descrição da Ocorrência:</label>
                            <textarea rows="3" class="text-sm p-3 border rounded-lg bg-slate-50 w-full" placeholder="Detalhes..." oninput="registerAction()"></textarea>
                        </div>
                        <div>
                            <div class="label-with-tooltip">
                                <label class="text-[10px] font-black text-slate-500 uppercase block">Tipo de Task (Classificação)</label>
                                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Categoria técnica para direcionar a correção.</div></div>
                            </div>
                            <select class="task-type-select w-full text-xs font-bold text-slate-700 bg-slate-100 p-2 rounded border border-slate-300" onchange="registerAction()">
                                <option value="" title="Selecione uma categoria">Selecione...</option>
                                <option value="Frontend Bug" title="Erros visuais, CSS quebrado, responsividade ou interações de UI falhas.">Bug de Interface / Frontend</option>
                                <option value="Backend Logic" title="Erros no servidor, regras de negócio incorretas ou falhas de API.">Erro de Lógica / Backend</option>
                                <option value="Security Vuln" title="Falhas de segurança, vulnerabilidades CVE, exposição de dados ou auth fraca.">Vulnerabilidade de Segurança</option>
                                <option value="Database" title="Queries lentas, migrações falhas, dados inconsistentes ou modelagem ruim.">Banco de Dados</option>
                                <option value="DevOps/CI-CD" title="Falhas em pipelines, Docker, deploy, variáveis de ambiente ou infra.">DevOps / CI-CD</option>
                                <option value="Code Quality" title="Código sujo, falta de padrões, complexidade ciclomática alta ou linting.">Qualidade de Código</option>
                                <option value="Performance" title="Carregamento lento, alto uso de memória/CPU ou gargalos de rede.">Performance</option>
                                <option value="Documentation" title="Falta de documentação, README desatualizado ou endpoints sem Swagger.">Documentação</option>
                                <option value="Compliance" title="Violação de LGPD/GDPR, logs inadequados ou falta de consentimento.">Compliance / LGPD</option>
                                <option value="Infrastructure" title="Configuração de servidor, firewall, DNS ou balanceamento de carga.">Infraestrutura</option>
                                <option value="Dependency" title="Bibliotecas desatualizadas, deprecated ou com vulnerabilidades conhecidas.">Dependências</option>
                                <option value="Architecture" title="Violação de padrões arquiteturais (SOLID, Clean Arch) ou acoplamento.">Arquitetura</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- GRADE ALINHADA: RISCO E STATUS -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div class="label-with-tooltip">
                                <label class="text-[10px] font-black text-slate-500 uppercase block">Risco</label>
                                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Nível de periculosidade do problema encontrado.</div></div>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="select-badge risk-badge"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base crítico hover:bg-red-50 hover:border-red-500 hover:text-red-600 transition">Crítico</span></label>
                                <label class="select-badge risk-badge"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base alto hover:bg-orange-50 hover:border-orange-500 hover:text-orange-600 transition">Alto</span></label>
                                <label class="select-badge risk-badge"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base médio hover:bg-yellow-50 hover:border-yellow-500 hover:text-yellow-600 transition">Médio</span></label>
                                <label class="select-badge risk-badge"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base baixo hover:bg-green-50 hover:border-green-500 hover:text-green-600 transition">Baixo</span></label>
                            </div>
                        </div>
                        <div>
                            <div class="label-with-tooltip">
                                <label class="text-[10px] font-black text-slate-500 uppercase block">Status</label>
                                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Situação atual da correção deste item.</div></div>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <label class="select-badge status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base pendente hover:bg-slate-200">Pendente</span></label>
                                <label class="select-badge status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base andamento hover:bg-orange-100">Andamento</span></label>
                                <label class="select-badge status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base concluido hover:bg-green-100">Concluído</span></label>
                                <label class="select-badge status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="badge-base bloqueado hover:bg-red-100">Bloqueado</span></label>
                            </div>
                        </div>
                    </div>

                    <!-- IMPACTOS (FULL WIDTH) -->
                    <div>
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-slate-500 uppercase block">Áreas Impactadas</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Áreas do negócio que podem ser afetadas por este problema.</div></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="select-badge impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="badge-base impact-active hover:bg-orange-50 hover:text-orange-600">Segurança</span></label>
                            <label class="select-badge impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="badge-base impact-active hover:bg-orange-50 hover:text-orange-600">Operacional</span></label>
                            <label class="select-badge impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="badge-base impact-active hover:bg-orange-50 hover:text-orange-600">Jurídico</span></label>
                            <label class="select-badge impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="badge-base impact-active hover:bg-orange-50 hover:text-orange-600">Privacidade</span></label>
                        </div>
                    </div>

                    <div class="pt-4 border-t border-slate-100">
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-orange-600 uppercase block tracking-widest">Evidências</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn bg-orange-100 text-orange-600 hover:bg-orange-600 hover:text-white" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Anexe capturas de tela ou links para documentar a falha.</div></div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-2">
                            <div class="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300"><p class="text-[10px] font-bold text-slate-400 mb-3 uppercase">Print/Imagem:</p><input type="file" accept="image/*" onchange="previewImage(this); registerAction();" class="no-print text-[10px] mb-2 cursor-pointer"><div class="image-container hidden"><img src="" class="image-preview"><button onclick="removeImage(this); registerAction();" class="no-print text-red-500 text-[10px] mt-2 font-bold uppercase">Remover</button></div></div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200"><p class="text-[10px] font-bold text-slate-400 mb-3 uppercase">Links:</p><div class="links-list space-y-2 mb-3"></div><button onclick="addLinkRow(this)" class="no-print text-orange-600 text-[10px] font-bold uppercase hover:underline">+ Link</button></div>
                        </div>
                    </div>

                    <!-- NOVO: BLOCO DE CÓDIGO -->
                    <div class="mt-4">
                        <div class="label-with-tooltip">
                            <label class="text-[10px] font-black text-slate-500 uppercase block">Trecho de Código / Log</label>
                            <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Cole logs de erro, configurações ou snippets de código relevantes.</div></div>
                        </div>
                        <textarea class="code-snippet text-xs font-mono p-3 border rounded-lg bg-slate-900 text-green-400 w-full" rows="4" placeholder="// Cole seu código ou log aqui..." oninput="registerAction()"></textarea>
                    </div>

                    <div><label class="text-[10px] font-black text-slate-500 uppercase block mb-2 mt-4">Recomendação Técnica:</label><textarea rows="2" class="text-sm p-3 border border-orange-100 rounded-lg bg-orange-50/30 w-full focus:bg-orange-50" placeholder="Ação corretiva..." oninput="registerAction()"></textarea></div>
                    
                    <!-- MOCKUP EMAIL -->
                    <div class="mt-4 border-t border-slate-100 pt-3 bg-slate-50 p-3 rounded-lg border border-slate-200 no-print opacity-80 hover:opacity-100 transition-opacity">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[9px] font-bold uppercase text-white bg-slate-400 px-2 py-0.5 rounded">Beta</span>
                            <div class="label-with-tooltip mb-0">
                                <label class="text-[10px] font-bold text-slate-600 uppercase flex items-center gap-1 cursor-pointer">
                                    <input type="checkbox" class="notify-checkbox accent-orange-600" onchange="toggleEmailInput(this); registerAction()"> Automação de E-mail
                                </label>
                                <div class="tooltip-wrapper"><button class="tooltip-btn" onclick="toggleTooltip(event, this)">?</button><div class="tooltip-content">Envia automaticamente o achado para o responsável assim que o relatório for gerado.</div></div>
                            </div>
                        </div>
                        <input type="email" class="email-notification text-sm p-2 border rounded w-full bg-white disabled:bg-slate-100 disabled:text-slate-400" placeholder="E-mail do responsável (ex: dev@cogitari.com.br)" oninput="registerAction()" disabled>
                    </div>

                </div>
            `;
            container.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function toggleEmailInput(checkbox) {
            const input = checkbox.parentElement.parentElement.querySelector('.email-notification');
            input.disabled = !checkbox.checked;
            if (!checkbox.checked) input.value = '';
        }

        function previewImage(input) { const container = input.parentElement.querySelector('.image-container'); const preview = container.querySelector('img'); if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { preview.src = e.target.result; container.classList.remove('hidden'); input.classList.add('hidden'); }; reader.readAsDataURL(input.files[0]); } }
        function removeImage(btn) { const container = btn.parentElement; const input = container.parentElement.querySelector('input[type="file"]'); container.classList.add('hidden'); input.classList.remove('hidden'); input.value = ''; }
        function addLinkRow(btn) { registerAction(); const list = btn.parentElement.querySelector('.links-list'); const row = document.createElement('div'); row.className = 'flex gap-1 items-center'; row.innerHTML = `<input type="text" class="text-[9px] flex-1 border px-1" placeholder="URL" onchange="registerAction()"><button onclick="this.parentElement.remove(); registerAction();" class="text-red-400">×</button>`; list.appendChild(row); }

        // --- DRIVE / MODAL ---
        function initGoogleDrive() { if (!CLIENT_ID) return; try { if (typeof google !== 'undefined' && google.accounts) { tokenClient = google.accounts.oauth2.initTokenClient({ client_id: CLIENT_ID, scope: SCOPES, callback: (resp) => { accessToken = resp.access_token; if (accessToken) uploadToDrive(); } }); } else setTimeout(initGoogleDrive, 500); } catch (e) { console.error(e); } }
        function toggleModal(show, title='', desc='', isError=false) { const modal = document.getElementById('loading-modal'); const icon = document.getElementById('loader-icon'); const btn = document.getElementById('close-modal-btn'); if (show) { modal.classList.remove('hidden'); modal.style.display='flex'; document.getElementById('status-title').innerText=title; document.getElementById('status-desc').innerText=desc; icon.className = isError ? "text-red-500 text-4xl mb-4" : "animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"; icon.innerHTML = isError ? "⚠️" : ""; btn.classList.toggle('hidden', !isError); } else { modal.classList.add('hidden'); modal.style.display='none'; } }
        async function handleDriveSave() { if (!CLIENT_ID) { alert("Configure o CLIENT_ID."); return; } if (!accessToken && tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' }); else if (accessToken) uploadToDrive(); else alert("Erro Google."); }
        async function uploadToDrive() {
            toggleModal(true, "Enviando...", "Gerando Doc...");
            const clientName = document.getElementById('client-name').value || "Empresa";
            const docId = document.getElementById('doc-id').value || "AUD";
            const fileName = `Auditoria - ${clientName} (${docId})`;
            const reportClone = document.getElementById('report-content').cloneNode(true);
            reportClone.querySelectorAll('.no-print').forEach(el => el.remove());
            const htmlContent = `<html><body style="font-family: Arial;">${reportClone.innerHTML}</body></html>`;
            const metadata = { name: fileName, mimeType: 'application/vnd.google-apps.document' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([htmlContent], { type: 'text/html' }));
            try { const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', { method: 'POST', headers: { 'Authorization': 'Bearer ' + accessToken }, body: form }); if (res.ok) { toggleModal(true, "Sucesso!", "Salvo no Drive.", false); document.getElementById('close-modal-btn').classList.remove('hidden'); document.getElementById('loader-icon').innerHTML = "✅"; document.getElementById('loader-icon').classList.remove('animate-spin'); } else throw new Error(); } catch (e) { toggleModal(true, "Erro", "Falha.", true); }
        }
    </script>
</body>
</html>