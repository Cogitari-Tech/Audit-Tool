<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cogitari Audit Tool v4.6 - Formal Signatures</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Identity Services -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            body { background: white; padding: 0; }
            .page { margin: 0; box-shadow: none; width: 100%; padding: 10mm 15mm; }
            .finding-card { border: 1px solid #eee; break-inside: avoid; }
            #signatures-container { break-inside: avoid; }
        }
        .page {
            background: white;
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            margin: 10mm auto;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            font-family: 'Segoe UI', system-ui, sans-serif;
            color: #1a1a1a;
            position: relative;
        }
        input, textarea, select { border: none; border-bottom: 1px dotted #94a3b8; width: 100%; padding: 4px; font-family: inherit; background: transparent; transition: all 0.2s; }
        input:focus, textarea:focus, select:focus { outline: none; background-color: #fff7ed; border-bottom: 2px solid #ea580c; }
        
        /* Modal Inputs */
        .modal-input { border: 1px solid #e2e8f0; border-radius: 6px; padding: 8px; background-color: white; width: 100%; }
        
        .section-title { border-left: 4px solid #ea580c; padding-left: 10px; font-weight: bold; text-transform: uppercase; font-size: 0.85rem; margin-bottom: 1.5rem; color: #9a3412; }
        .finding-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 1.5rem; margin-bottom: 2.5rem; background-color: #ffffff; position: relative; z-index: 10; }
        
        /* Badges */
        .risk-badge input:checked + span.crítico { background-color: #ef4444; color: white; border-color: #ef4444; }
        .risk-badge input:checked + span.alto { background-color: #f97316; color: white; border-color: #f97316; }
        .risk-badge input:checked + span.médio { background-color: #eab308; color: white; border-color: #eab308; }
        .risk-badge input:checked + span.baixo { background-color: #22c55e; color: white; border-color: #22c55e; }
        .impact-badge input:checked + span { background-color: #ea580c; color: white; border-color: #ea580c; }
        .status-badge input:checked + span.pendente { background-color: #64748b; color: white; border-color: #64748b; }
        .status-badge input:checked + span.andamento { background-color: #ea580c; color: white; border-color: #ea580c; }
        .status-badge input:checked + span.concluido { background-color: #10b981; color: white; border-color: #10b981; }
        .status-badge input:checked + span.bloqueado { background-color: #dc2626; color: white; border-color: #dc2626; }

        .image-preview { max-width: 100%; max-height: 250px; object-fit: contain; border-radius: 4px; margin-top: 10px; border: 1px solid #e2e8f0; }
        
        .watermark { 
            position: absolute; 
            bottom: 30px; 
            right: 30px; 
            font-size: 8px; 
            font-weight: 900; 
            color: #f1f5f9; 
            text-transform: uppercase; 
            letter-spacing: 5px; 
            pointer-events: none; 
            user-select: none; 
            z-index: 1; 
        }
        
        #loading-modal, #auditor-modal, #signature-modal { display: none; }
    </style>
</head>
<body class="bg-slate-100 p-4 pb-20">

    <!-- Barra de Ferramentas Superior -->
    <div class="no-print bg-slate-900 text-white p-4 mb-8 rounded-2xl max-w-6xl mx-auto flex justify-between items-center shadow-2xl sticky top-4 z-[100] border-b-4 border-orange-600">
        <div class="flex items-center gap-4">
            <div class="bg-white p-1 rounded-lg h-10 w-10 flex items-center justify-center overflow-hidden">
                <!-- LOGO COGITARI -->
                <img src="logo-cogitari.png" alt="Logo" class="h-full w-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                <svg style="display:none" xmlns="http://www.w3.org/2003/svg" viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
            </div>
            <div class="hidden md:block">
                <h1 class="font-bold text-lg leading-tight flex items-center gap-2">
                    Cogitari Audit Tool
                    <span class="bg-orange-600 text-white text-[10px] px-2 py-0.5 rounded-full uppercase tracking-widest">v4.6</span>
                </h1>
                <p class="text-[10px] uppercase tracking-widest opacity-60 italic">Traceability & Compliance</p>
            </div>
        </div>

        <!-- Seletor de Auditor Ativo -->
        <div class="flex items-center gap-2 bg-slate-800 px-3 py-1.5 rounded-xl border border-slate-700">
            <div class="text-[10px] font-bold text-orange-500 uppercase tracking-widest text-right leading-tight">
                Auditor<br>Ativo
            </div>
            <select id="active-auditor-selector" class="bg-transparent text-white text-xs font-bold border-none focus:ring-0 cursor-pointer w-32 md:w-40" onchange="/* Apenas troca o contexto */">
                <!-- Preenchido via JS -->
            </select>
        </div>

        <div class="flex gap-2">
            <button onclick="toggleAuditorModal(true)" class="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 border border-slate-600" title="Gerenciar Equipe">
                <svg xmlns="http://www.w3.org/2003/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                Adicionar Auditor
            </button>
            <button onclick="addFinding(true)" class="bg-orange-600 hover:bg-orange-700 text-white px-3 py-2 rounded-xl text-xs font-bold transition-all flex items-center gap-2 shadow-lg">
                + Novo Achado
            </button>
            <button onclick="handleDriveSave()" class="bg-white text-slate-900 px-4 py-2 rounded-xl text-xs font-bold transition-all hover:bg-slate-100 flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2003/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Drive
            </button>
            <button onclick="validateAndPrint()" class="bg-white text-slate-900 px-4 py-2 rounded-xl text-xs font-bold transition-all hover:bg-slate-100 flex items-center gap-2 border border-slate-200">
                <svg xmlns="http://www.w3.org/2003/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Gerar PDF
            </button>
        </div>
    </div>

    <!-- Modal de Gestão de Auditores -->
    <div id="auditor-modal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b-4 border-orange-600">
                <h3 class="font-bold text-sm uppercase tracking-wider">Gestão de Equipe</h3>
                <button onclick="toggleAuditorModal(false)" class="hover:text-orange-400">✕</button>
            </div>
            <div class="p-6">
                <div class="flex gap-2 mb-4">
                    <input type="text" id="new-auditor-name" class="modal-input flex-1 text-sm" placeholder="Nome (ex: David QA)">
                    <button onclick="addAuditor()" class="bg-orange-600 text-white px-4 rounded-lg font-bold text-lg hover:bg-orange-700">+</button>
                </div>
                <div class="text-[10px] uppercase font-bold text-slate-400 mb-2">Auditores Disponíveis:</div>
                <ul id="auditor-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <!-- Lista gerada via JS -->
                </ul>
            </div>
            <div class="bg-slate-50 p-4 text-center">
                <button onclick="toggleAuditorModal(false)" class="text-orange-600 text-xs font-bold uppercase hover:underline">Salvar e Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Assinatura Manual -->
    <div id="signature-modal" class="fixed inset-0 bg-black/70 z-[200] flex items-center justify-center p-4 backdrop-blur-sm hidden">
        <div class="bg-white rounded-2xl max-w-sm w-full shadow-2xl overflow-hidden animate-in zoom-in-95 duration-200">
            <div class="bg-slate-900 p-4 flex justify-between items-center text-white border-b-4 border-orange-600">
                <h3 class="font-bold text-sm uppercase tracking-wider">Dados da Assinatura</h3>
                <button onclick="toggleSignatureModal(false)" class="hover:text-orange-400">✕</button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nome e Sobrenome</label>
                    <input type="text" id="signer-name" class="modal-input" placeholder="Ex: Maurício Caique">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cargo / Função</label>
                    <input type="text" id="signer-role" class="modal-input" placeholder="Ex: CTO & Security Lead">
                </div>
            </div>
            <div class="bg-slate-50 p-4 text-center">
                <button onclick="confirmSignature()" class="bg-orange-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-orange-700 w-full">Confirmar Assinatura</button>
            </div>
        </div>
    </div>

    <!-- Modal de Status -->
    <div id="loading-modal" class="fixed inset-0 bg-black/50 z-[200] flex items-center justify-center p-4 hidden">
        <div class="bg-white p-8 rounded-2xl max-w-sm w-full text-center shadow-2xl">
            <div id="loader-icon" class="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4"></div>
            <h3 id="status-title" class="font-bold text-lg mb-2 text-slate-800">Sincronizando...</h3>
            <p id="status-desc" class="text-sm text-slate-500 mb-6">Processando.</p>
            <button id="close-modal-btn" onclick="toggleModal(false)" class="hidden bg-slate-900 text-white px-6 py-2 rounded-xl font-bold text-sm w-full">Entendido</button>
        </div>
    </div>

    <div id="report-content">
        <div class="page" id="main-page">
            <!-- Cabeçalho com Identidade Cogitari -->
            <div class="flex justify-between items-start mb-8 border-b-2 border-slate-900 pb-6">
                <div class="flex items-center gap-4">
                    <!-- Logo Container -->
                    <div class="h-16 w-16 bg-white border border-slate-200 rounded-xl flex items-center justify-center p-1 overflow-hidden shadow-sm">
                        <!-- LOGO REFORÇADA NO CORPO -->
                        <img src="logo-cogitari.png" alt="Cogitari Logo" class="w-full h-full object-contain" onerror="this.style.display='none'; this.nextElementSibling.style.display='block'">
                        <svg style="display:none" xmlns="http://www.w3.org/2003/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#ea580c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg>
                    </div>
                    <div>
                        <h2 class="text-2xl font-black uppercase tracking-tighter text-slate-900">Relatório de Auditoria</h2>
                        <div class="flex items-center gap-2 mt-1">
                            <div class="h-1 w-8 bg-orange-600"></div>
                            <p class="text-xs font-bold uppercase tracking-widest text-slate-500">Cogitari Tech</p>
                        </div>
                    </div>
                </div>
                <div class="text-right">
                    <div class="text-[10px] font-bold text-slate-400 uppercase">Documento ID</div>
                    <input type="text" id="doc-id" value="CGT-2026-AUD-001" class="text-sm font-mono font-bold text-slate-600 text-right bg-transparent border-none p-0 focus:bg-transparent" onchange="registerAction()">
                </div>
            </div>

            <!-- Dados da Empresa -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-10">
                <div class="space-y-4">
                    <div><label class="text-[10px] font-black text-slate-400 uppercase block">Empresa Cliente</label><input type="text" id="client-name" placeholder="Ex: Amuri SaaS" onchange="registerAction()"></div>
                    <div><label class="text-[10px] font-black text-slate-400 uppercase block">Ambiente</label><input type="text" placeholder="Ex: Produção / Vercel" onchange="registerAction()"></div>
                </div>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-[10px] font-black text-slate-400 uppercase block">Início</label><input type="text" placeholder="DD/MM/AA" onchange="registerAction()"></div>
                        <div><label class="text-[10px] font-black text-slate-400 uppercase block">Fim</label><input type="text" placeholder="DD/MM/AA" onchange="registerAction()"></div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-400 uppercase block">Auditor Líder (Ref.)</label>
                        <select id="lead-auditor" class="auditor-select-global w-full text-sm font-medium" onchange="registerAction()">
                            <option>Maurício Caique (CTO)</option>
                        </select>
                    </div>
                </div>
            </div>

            <h3 class="section-title">1. Sumário Executivo</h3>
            <textarea rows="4" class="text-sm w-full p-4 bg-slate-50 rounded-xl mb-12 border border-slate-100 focus:bg-orange-50" placeholder="Resumo dos achados principais..." onchange="registerAction()"></textarea>

            <h3 class="section-title">2. Registro de Ocorrências Técnicas</h3>
            <div id="findings-container">
                <!-- Achados aqui -->
            </div>
            
            <div class="no-print flex justify-center py-6">
                <button onclick="addFinding(true)" class="group flex items-center gap-3 bg-slate-100 hover:bg-orange-600 hover:text-white px-8 py-4 rounded-2xl transition-all duration-300 border-2 border-dashed border-slate-300 hover:border-orange-600">
                    <span class="bg-orange-600 text-white p-1 rounded-full group-hover:bg-white group-hover:text-orange-600">
                        <svg xmlns="http://www.w3.org/2003/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </span>
                    <span class="font-bold uppercase text-xs tracking-widest">Adicionar Outra Ocorrência</span>
                </button>
            </div>

            <div class="watermark">Cogitari Tech</div>
        </div>

        <!-- Parecer Final e Assinaturas -->
        <div class="page">
            <h3 class="section-title">3. Parecer Final</h3>
            <textarea rows="15" class="text-sm w-full p-6 bg-slate-50 rounded-2xl mb-12 focus:bg-orange-50" placeholder="Conclusão da auditoria..." onchange="registerAction()"></textarea>

            <!-- Seção Dinâmica de Assinaturas -->
            <h3 class="section-title mb-8">4. Assinaturas e Responsabilidade Técnica</h3>
            <div class="bg-slate-50 p-6 rounded-xl border border-slate-200 min-h-[150px] relative">
                <p class="text-[10px] text-slate-400 uppercase tracking-wider mb-6 text-center">Registro de Modificações e Responsáveis</p>
                
                <div id="signatures-container" class="grid grid-cols-2 gap-x-12 gap-y-12">
                    <!-- Inicialmente vazio -->
                    <div class="col-span-2 text-center text-slate-400 italic text-xs py-8">
                        Aguardando início da auditoria...<br>
                        (Edite o documento ou clique no botão abaixo para assinar)
                    </div>
                </div>

                <!-- Botão de Assinatura Manual -->
                <div class="no-print absolute bottom-4 right-4">
                    <button onclick="openSignatureModal()" class="bg-slate-800 text-white text-[10px] uppercase font-bold px-3 py-1.5 rounded hover:bg-slate-700 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2003/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        Assinar Agora
                    </button>
                </div>
            </div>
            
            <div class="watermark">Cogitari Tech</div>
        </div>
    </div>

    <script>
        const CLIENT_ID = ''; 
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let accessToken = null;
        
        // Estado
        let auditors = ['Maurício Caique'];
        let activeSignatures = {}; // { "Nome Auditor": { date: "...", role: "..." } }

        window.onload = function() {
            initGoogleDrive();
            renderAuditorList();
            updateAuditorSelects();
            addFinding(false); 
            renderSignatures(); 
        };

        // --- LÓGICA DE ASSINATURAS (TRACEABILITY) ---
        
        function registerAction(roleOverride = null) {
            const activeAuditor = document.getElementById('active-auditor-selector').value;
            if (!activeAuditor) return;

            const timestamp = new Date().toLocaleString('pt-BR');
            
            // Se já existe, mantém o cargo antigo a menos que haja override
            let currentRole = activeSignatures[activeAuditor]?.role || "Auditor Técnico";
            if (roleOverride) currentRole = roleOverride;

            activeSignatures[activeAuditor] = {
                date: timestamp,
                role: currentRole
            };
            
            renderSignatures();
        }

        // Assinatura Manual com Modal
        function openSignatureModal() {
            const activeAuditor = document.getElementById('active-auditor-selector').value;
            document.getElementById('signer-name').value = activeAuditor;
            document.getElementById('signer-role').value = activeSignatures[activeAuditor]?.role || "";
            toggleSignatureModal(true);
        }

        function toggleSignatureModal(show) {
            document.getElementById('signature-modal').style.display = show ? 'flex' : 'none';
        }

        function confirmSignature() {
            const name = document.getElementById('signer-name').value;
            const role = document.getElementById('signer-role').value;

            if(!name || !role) {
                alert("Preencha Nome e Cargo.");
                return;
            }

            // Adiciona à lista de auditores se for novo
            if(!auditors.includes(name)) {
                auditors.push(name);
                renderAuditorList();
                updateAuditorSelects();
                document.getElementById('active-auditor-selector').value = name;
            }

            const timestamp = new Date().toLocaleString('pt-BR');
            activeSignatures[name] = { date: timestamp, role: role };
            
            renderSignatures();
            toggleSignatureModal(false);
        }

        function renderSignatures() {
            const container = document.getElementById('signatures-container');
            const signers = Object.keys(activeSignatures);

            if (signers.length === 0) {
                container.innerHTML = `
                    <div class="col-span-2 text-center text-slate-400 italic text-xs py-8">
                        Aguardando início da auditoria...<br>
                        (Edite o documento ou clique no botão abaixo para assinar)
                    </div>`;
                return;
            }

            container.innerHTML = signers.map(auditor => `
                <div class="border-t-2 border-slate-900 pt-3 animate-in fade-in slide-in-from-bottom-2">
                    <p class="text-[11px] font-black uppercase text-slate-900">${auditor}</p>
                    <p class="text-[10px] text-slate-600 font-bold uppercase mb-1">${activeSignatures[auditor].role}</p>
                    <div class="flex justify-between items-end mt-1">
                        <div class="flex items-center gap-1 text-green-600">
                            <svg xmlns="http://www.w3.org/2003/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
                            <p class="text-[9px] font-bold uppercase">Verificado</p>
                        </div>
                        <p class="text-[9px] text-slate-400 text-right">Última Ação:<br>${activeSignatures[auditor].date}</p>
                    </div>
                </div>
            `).join('');
        }

        // --- VALIDAÇÃO DE SEGURANÇA ---
        function validateAndPrint() {
            if (Object.keys(activeSignatures).length === 0) {
                alert("BLOQUEIO DE SEGURANÇA:\n\nNenhuma atividade foi registrada.\nO relatório está em branco. Edite algum campo ou clique em 'Assinar Agora' para validar o documento.");
                return;
            }
            window.print();
        }

        // --- GESTÃO DE AUDITORES ---
        function toggleAuditorModal(show) {
            document.getElementById('auditor-modal').style.display = show ? 'flex' : 'none';
        }

        function addAuditor() {
            const input = document.getElementById('new-auditor-name');
            const name = input.value.trim();
            if (name && !auditors.includes(name)) {
                auditors.push(name);
                input.value = '';
                renderAuditorList();
                updateAuditorSelects();
            }
        }

        function removeAuditor(index) {
            if (confirm('Remover este auditor?')) {
                const name = auditors[index];
                delete activeSignatures[name];
                auditors.splice(index, 1);
                renderAuditorList();
                updateAuditorSelects();
                renderSignatures();
            }
        }

        function renderAuditorList() {
            const list = document.getElementById('auditor-list');
            list.innerHTML = auditors.map((aud, index) => `
                <li class="flex justify-between items-center bg-slate-100 p-2 rounded text-sm border border-slate-200">
                    <span class="font-bold text-slate-700">${aud}</span>
                    <button onclick="removeAuditor(${index})" class="text-red-500 font-bold hover:text-red-700">×</button>
                </li>
            `).join('');
        }

        function updateAuditorSelects() {
            const activeSelect = document.getElementById('active-auditor-selector');
            const currentActive = activeSelect.value;
            activeSelect.innerHTML = auditors.map(aud => `<option value="${aud}">${aud}</option>`).join('');
            if (auditors.includes(currentActive)) activeSelect.value = currentActive;

            const leadSelect = document.getElementById('lead-auditor');
            const currentLead = leadSelect.value;
            leadSelect.innerHTML = auditors.map(aud => `<option value="${aud}">${aud}</option>`).join('');
            if (auditors.includes(currentLead)) leadSelect.value = currentLead;
        }

        // --- DRIVE & AUTH ---
        function initGoogleDrive() {
            if (!CLIENT_ID) return;
            try {
                if (typeof google !== 'undefined' && google.accounts) {
                    tokenClient = google.accounts.oauth2.initTokenClient({
                        client_id: CLIENT_ID, scope: SCOPES,
                        callback: (resp) => { accessToken = resp.access_token; if (accessToken) uploadToDrive(); }
                    });
                } else setTimeout(initGoogleDrive, 500);
            } catch (e) { console.error(e); }
        }

        function toggleModal(show, title='', desc='', isError=false) {
            const modal = document.getElementById('loading-modal');
            const icon = document.getElementById('loader-icon');
            const btn = document.getElementById('close-modal-btn');
            
            if (show) {
                modal.classList.remove('hidden');
                modal.style.display = 'flex';
                document.getElementById('status-title').innerText = title;
                document.getElementById('status-desc').innerText = desc;
                icon.className = isError ? "text-red-500 text-4xl mb-4" : "animate-spin rounded-full h-12 w-12 border-b-2 border-orange-600 mx-auto mb-4";
                icon.innerHTML = isError ? "⚠️" : "";
                btn.classList.toggle('hidden', !isError);
            } else {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            }
        }

        async function handleDriveSave() {
            if (!CLIENT_ID) { alert("Configure o CLIENT_ID no código."); return; }
            if (!accessToken && tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' });
            else if (accessToken) uploadToDrive();
            else alert("Erro de conexão Google.");
        }

        async function uploadToDrive() {
            toggleModal(true, "Enviando...", "Gerando Google Doc...");
            const clientName = document.getElementById('client-name').value || "Empresa";
            const docId = document.getElementById('doc-id').value || "AUD";
            const fileName = `Auditoria - ${clientName} (${docId})`;

            const reportClone = document.getElementById('report-content').cloneNode(true);
            reportClone.querySelectorAll('.no-print').forEach(el => el.remove());
            const htmlContent = `<html><body style="font-family: Arial;">${reportClone.innerHTML}</body></html>`;

            const metadata = { name: fileName, mimeType: 'application/vnd.google-apps.document' };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', new Blob([htmlContent], { type: 'text/html' }));

            try {
                const res = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST', headers: { 'Authorization': 'Bearer ' + accessToken }, body: form
                });
                if (res.ok) {
                    toggleModal(true, "Sucesso!", "Salvo no Drive.", false);
                    document.getElementById('close-modal-btn').classList.remove('hidden');
                    document.getElementById('loader-icon').innerHTML = "✅";
                    document.getElementById('loader-icon').classList.remove('animate-spin');
                } else throw new Error();
            } catch (e) { toggleModal(true, "Erro", "Falha no upload.", true); }
        }

        // --- ACHADOS ---
        let findingCount = 0;
        function addFinding(shouldRegister = true) {
            findingCount++;
            if (shouldRegister) registerAction();

            const container = document.getElementById('findings-container');
            const div = document.createElement('div');
            div.className = 'finding-card border-l-8 border-l-slate-800 animate-in fade-in slide-in-from-top-4 duration-300';
            div.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center gap-4">
                        <span class="bg-slate-800 text-white px-4 py-1.5 rounded-full text-[10px] font-bold uppercase tracking-widest">Achado #0${findingCount}</span>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Resp:</span>
                            <select class="auditor-select-finding text-[10px] bg-slate-100 rounded px-2 py-1 border-none focus:ring-0 cursor-pointer text-slate-700 font-bold" onchange="registerAction()">
                                ${auditors.map(a => `<option>${a}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                    <button onclick="this.closest('.finding-card').remove(); registerAction();" class="no-print text-red-500 hover:text-red-700 text-[10px] font-bold uppercase">Excluir</button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase block mb-2">Descrição da Ocorrência:</label>
                        <textarea rows="3" class="text-sm p-3 border rounded-lg bg-slate-50 w-full" placeholder="Detalhes do problema..." onchange="registerAction()"></textarea>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <label class="text-[10px] font-black text-slate-500 uppercase block mb-3">Nível de Risco:</label>
                            <div class="flex gap-2">
                                <label class="risk-badge flex-1"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="crítico block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Crítico</span></label>
                                <label class="risk-badge flex-1"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="alto block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Alto</span></label>
                                <label class="risk-badge flex-1"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="médio block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Médio</span></label>
                                <label class="risk-badge flex-1"><input type="radio" name="risk-${findingCount}" class="hidden" onchange="registerAction()"><span class="baixo block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Baixo</span></label>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] font-black text-slate-500 uppercase block mb-3">Impactos:</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Segurança</span></label>
                                <label class="impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Operacional</span></label>
                                <label class="impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Jurídico</span></label>
                                <label class="impact-badge"><input type="checkbox" class="hidden" onchange="registerAction()"><span class="block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Privacidade</span></label>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase block mb-3">Status da Ação:</label>
                        <div class="grid grid-cols-4 gap-2">
                            <label class="status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="pendente block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Pendente</span></label>
                            <label class="status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="andamento block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Em Andamento</span></label>
                            <label class="status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="concluido block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Concluído</span></label>
                            <label class="status-badge"><input type="radio" name="status-${findingCount}" class="hidden" onchange="registerAction()"><span class="bloqueado block text-center py-2 border rounded-lg text-[10px] font-bold uppercase cursor-pointer transition">Bloqueado</span></label>
                        </div>
                    </div>
                    <div class="pt-4 border-t border-slate-100">
                        <label class="text-[10px] font-black text-blue-600 uppercase block mb-4 tracking-widest">Evidências e Referências</label>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-300">
                                <p class="text-[10px] font-bold text-slate-400 mb-3 uppercase">Print/Imagem:</p>
                                <input type="file" accept="image/*" onchange="previewImage(this); registerAction();" class="no-print text-[10px] mb-2 cursor-pointer">
                                <div class="image-container hidden">
                                    <img src="" class="image-preview" alt="Evidência">
                                    <button onclick="removeImage(this); registerAction();" class="no-print text-red-500 text-[10px] mt-2 font-bold uppercase">Remover</button>
                                </div>
                            </div>
                            <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                                <p class="text-[10px] font-bold text-slate-400 mb-3 uppercase">Links:</p>
                                <div class="links-list space-y-2 mb-3"></div>
                                <button onclick="addLinkRow(this)" class="no-print text-blue-600 text-[10px] font-bold uppercase hover:underline">+ Link</button>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] font-black text-slate-500 uppercase block mb-2">Recomendação Técnica:</label>
                        <textarea rows="2" class="text-sm p-3 border rounded-lg bg-blue-50/30 w-full" placeholder="Ação corretiva..." onchange="registerAction()"></textarea>
                    </div>
                </div>
            `;
            container.appendChild(div);
            div.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function previewImage(input) {
            const container = input.parentElement.querySelector('.image-container');
            const preview = container.querySelector('img');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => { preview.src = e.target.result; container.classList.remove('hidden'); input.classList.add('hidden'); }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage(btn) {
            const container = btn.parentElement;
            const input = container.parentElement.querySelector('input[type="file"]');
            container.classList.add('hidden');
            input.classList.remove('hidden');
            input.value = '';
        }

        function addLinkRow(btn) {
            registerAction();
            const list = btn.parentElement.querySelector('.links-list');
            const row = document.createElement('div');
            row.className = 'flex gap-1 items-center';
            row.innerHTML = `<input type="text" class="text-[9px] flex-1 border px-1" placeholder="URL" onchange="registerAction()"><button onclick="this.parentElement.remove(); registerAction();" class="text-red-400">×</button>`;
            list.appendChild(row);
        }
    </script>
</body>
</html>