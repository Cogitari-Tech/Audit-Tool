---
description: Regras para integra√ß√£o com WordPress REST API
globs: src/lib/integrations/wordpress/**/*
---
# üìù INTEGRA√á√ÉO WORDPRESS

## Contexto/Princ√≠pios
WordPress alimenta ~43% da web, mas suas APIs variam drasticamente dependendo da hospedagem e plugins de seguran√ßa.
- **Auth**: NUNCA use Basic Auth com senha de login real. Use **Application Passwords**.
- **Performance**: Hospedagens compartilhadas frequentemente retornam 429 ou 502 sob carga. Exponential Backoff √© obrigat√≥rio.
- **SEO**: O post deve ser criado com meta-dados otimizados (Yoast/RankMath integration se poss√≠vel).

## Implementa√ß√£o

### Autentica√ß√£o Segura
```typescript
// ‚úÖ CORRETO: Uso de Application Passwords
const getAuthHeader = (username: string, appPassword: string) => {
  // Remove espa√ßos da app password (comum em UX de c√≥pia)
  const cleanPassword = appPassword.replace(/\s/g, '');
  const token = Buffer.from(`${username}:${cleanPassword}`).toString('base64');
  return `Basic ${token}`;
};
```

### Tratamento de Erros e Backoff (429/502)
```typescript
// ‚úÖ CORRETO: Retry logic para instabilidade de servidor
async function createPostWithRetry(data: PostData, retries = 3): Promise<Result<Post>> {
  for (let i = 0; i < retries; i++) {
    const response = await fetch(`${wpUrl}/wp-json/wp/v2/posts`, {
      method: 'POST',
      // headers...
      body: JSON.stringify({
        title: data.title,
        content: data.htmlContent,
        status: 'publish', // ou 'draft'
        meta: {
          _yoast_wpseo_metadesc: data.seoDescription // Exemplo Yoast
        }
      })
    });

    if (response.ok) return Result.ok(await response.json());

    // Se for erro de servidor ou rate limit, espera e tenta de novo
    if ([429, 500, 502, 503, 504].includes(response.status)) {
      const waitTime = Math.pow(2, i) * 1000; // 1s, 2s, 4s
      await sleep(waitTime);
      continue;
    }

    return Result.fail(`Erro WP: ${response.status}`);
  }
  return Result.fail('Falha ap√≥s m√∫ltiplas tentativas no WordPress');
}
```

### ‚ùå ERRADO: Anti-padr√µes
```typescript
// ‚ùå XML-RPC √© obsoleto e inseguro. Use REST API.
// ‚ùå N√£o injete HTML sem sanitiza√ß√£o pr√©via.
// ‚ùå N√£o assuma que categorias/tags existem. Use get_or_create.
```

## Edge Cases / Alertas
- ‚ö†Ô∏è **Firewalls (WAF)**: Cloudflare ou Wordfence podem bloquear requisi√ß√µes de API vindas de cloud IPs. O usu√°rio pode precisar whitelistar o IP do Amuri.
- ‚ö†Ô∏è **Imagens**: Upload de m√≠dia deve ser feito em endpoint separado (`/wp/v2/media`) e o ID retornado vinculado ao post (`featured_media`).
- üö® **Permiss√µes**: Application Passwords herdam as permiss√µes do usu√°rio. Garanta que o usu√°rio tenha role de 'Editor' ou 'Author'.
