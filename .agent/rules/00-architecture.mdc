---
description: "Regras de Clean Architecture (OBRIGATÃ“RIO EM TODAS AS TAREFAS)"
alwaysApply: true
---

# ğŸ›ï¸ REGRAS GLOBAIS DE ARQUITETURA - AMURI SAAS

## PrincÃ­pios Fundamentais

### Clean Architecture (Camadas)
- **Domain Layer** (src/domain/): Entidades, Value Objects, Regras de NegÃ³cio
- **Application Layer** (src/application/): Use Cases, DTOs, Interfaces
- **Infrastructure Layer** (src/infrastructure/): ImplementaÃ§Ãµes de APIs, DB, External Services
- **Presentation Layer** (src/app/, src/components/): UI, Controllers

### SOLID Principles
- **Single Responsibility**: Cada mÃ³dulo tem UMA razÃ£o para mudar
- **Open/Closed**: Aberto para extensÃ£o, fechado para modificaÃ§Ã£o
- **Liskov Substitution**: Subtipos devem ser substituÃ­veis por tipos base
- **Interface Segregation**: Interfaces especÃ­ficas > Interfaces genÃ©ricas
- **Dependency Inversion**: Dependa de abstraÃ§Ãµes, nÃ£o de implementaÃ§Ãµes concretas

### Domain-Driven Design (DDD)
- **Bounded Contexts**: Cada mÃ³dulo de integraÃ§Ã£o (YouTube, TikTok) Ã© um contexto isolado
- **Aggregates**: User + Profile + Credits Ã© um agregado
- **Value Objects**: Email, CPF, APIKey devem ser Value Objects imutÃ¡veis
- **Domain Events**: PublishSucceeded, CreditsPurchased, UserBanned

## Estrutura de Pastas (OBRIGATÃ“RIA)

src/
â”œâ”€â”€ app/                    # Next.js App Router (Presentation)
â”œâ”€â”€ components/             # UI Components
â”‚   â”œâ”€â”€ ui/                # shadcn/ui base components
â”‚   â””â”€â”€ features/          # Feature-specific components
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ domain/            # Domain Layer
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”œâ”€â”€ value-objects/
â”‚   â”‚   â””â”€â”€ events/
â”‚   â”œâ”€â”€ application/       # Application Layer
â”‚   â”‚   â”œâ”€â”€ use-cases/
â”‚   â”‚   â””â”€â”€ dtos/
â”‚   â”œâ”€â”€ infrastructure/    # Infrastructure Layer
â”‚   â”‚   â”œâ”€â”€ db/           # Prisma, Supabase clients
â”‚   â”‚   â”œâ”€â”€ integrations/ # YouTube, TikTok, etc.
â”‚   â”‚   â””â”€â”€ mcp/          # MCP servers
â”‚   â””â”€â”€ utils/            # Helpers
â””â”€â”€ types/                 # TypeScript types

## Nomenclatura (STRICT)

### Arquivos
- Componentes React: `PascalCase.tsx` (ex: `UserProfile.tsx`)
- Hooks: `use-kebab-case.ts` (ex: `use-auth.ts`)
- Utils: `kebab-case.ts` (ex: `format-date.ts`)
- Types: `kebab-case.d.ts` (ex: `api-response.d.ts`)

### VariÃ¡veis e FunÃ§Ãµes
- VariÃ¡veis: `camelCase` (ex: `userId`, `creditsBalance`)
- Constantes: `UPPER_SNAKE_CASE` (ex: `MAX_UPLOAD_SIZE`, `API_BASE_URL`)
- FunÃ§Ãµes: `camelCase` com verbos (ex: `getUserProfile`, `validateEmail`)
- Componentes: `PascalCase` (ex: `BuyCoinsButton`)

### Database (Prisma Schema)
- Tabelas: `snake_case` no plural (ex: `user_profiles`, `coin_transactions`)
- Colunas: `snake_case` (ex: `created_at`, `credits_balance`)
- Enums: `PascalCase` (ex: `UserRole`, `TransactionType`)

## TypeScript (STRICT MODE)
````typescript
// tsconfig.json DEVE conter:
{
  "compilerOptions": {
    "strict": true,
    "noImplicitAny": true,
    "strictNullChecks": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true
  }
}

// âŒ NUNCA use 'any' sem justificativa explÃ­cita
const data: any = {}; // ERRADO

// âœ… Use tipos especÃ­ficos ou unknown
const data: UserProfile | null = null; // CORRETO
````

## Error Handling (OBRIGATÃ“RIO)
````typescript
// âœ… CORRETO: Sempre use Result Pattern ou throw tipado
type Result<T> = 
  | { success: true; data: T }
  | { success: false; error: Error };

async function fetchUser(id: string): Promise<Result<User>> {
  try {
    const user = await db.user.findUnique({ where: { id } });
    if (!user) {
      return { success: false, error: new Error('User not found') };
    }
    return { success: true, data: user };
  } catch (error) {
    return { success: false, error: error as Error };
  }
}

// âŒ NUNCA retorne null ou undefined sem documentaÃ§Ã£o
async function getUser(id: string) {
  return await db.user.findUnique({ where: { id } }); // EVITAR
}
````

## Logging e Observabilidade
````typescript
// âœ… Use Sentry para errors crÃ­ticos
import * as Sentry from '@sentry/nextjs';

try {
  // operaÃ§Ã£o crÃ­tica
} catch (error) {
  Sentry.captureException(error, {
    tags: { module: 'youtube-upload' },
    extra: { userId, videoId }
  });
  throw error;
}

// âœ… Use console estruturado em dev
console.log(JSON.stringify({
  timestamp: new Date().toISOString(),
  level: 'info',
  module: 'auth',
  message: 'User logged in',
  userId: user.id
}));
````

## ADRs (Architecture Decision Records)

Toda decisÃ£o arquitetural DEVE ser documentada em `docs/adr/`:

docs/
â””â”€â”€ adr/
â”œâ”€â”€ 001-context-sharding.md
â”œâ”€â”€ 002-landing-page-architecture.md
â”œâ”€â”€ 003-escolha-nextjs-app-router.md
â”œâ”€â”€ 004-supabase-vs-planetscale.md
â”œâ”€â”€ 005-modelo-byok-para-apis.md
â””â”€â”€ ...

Formato:
````markdown
# ADR 001: Escolha do Next.js App Router

**Status:** Aceito
**Data:** 2026-01-16
**Decisores:** @tech-team

## Contexto
Precisamos de SSR para SEO e performance na landing page...

## DecisÃ£o
Usar Next.js 14+ com App Router...

## ConsequÃªncias
- âœ… Pros: SEO nativo, streaming...
- âŒ Cons: Curva de aprendizado...
````

## Spec-Driven Development (SDD)

ANTES de codificar qualquer feature:

1. Criar arquivo `.spec.md` em `docs/specs/`
2. Detalhar:
   - Objetivo da feature
   - Endpoints/APIs afetados
   - MudanÃ§as no schema do DB
   - Casos de borda
   - Testes necessÃ¡rios
3. Revisar e aprovar
4. ENTÃƒO implementar

## Git Workflow
````bash
# Branches
main              # ProduÃ§Ã£o (protegido)
â”œâ”€â”€ staging       # Staging (auto-deploy)
â””â”€â”€ dev           # Desenvolvimento

# Feature branches
feature/user-auth
fix/youtube-quota-error
refactor/prisma-queries

# Commits (Conventional Commits)
feat: add YouTube upload with resumable protocol
fix: handle 403 quota exceeded error
docs: update ADR for BYOK strategy
test: add e2e test for coin purchase flow
````

## Regras de Merge

- âŒ NUNCA merge direto em `main` sem PR
- âœ… PR deve ter:
  - [ ] Testes passando (CI/CD green)
  - [ ] Code review de 1+ dev
  - [ ] Spec atualizada (se aplicÃ¡vel)
  - [ ] ADR criado/atualizado (se decisÃ£o arquitetural)

## Performance Budgets

- Lighthouse Score mÃ­nimo: 90 (mobile)
- First Contentful Paint: < 1.5s
- Largest Contentful Paint: < 2.5s
- Time to Interactive: < 3.5s
- Cumulative Layout Shift: < 0.1

## SeguranÃ§a (NON-NEGOTIABLE)
````typescript
// âŒ NUNCA exponha secrets no cliente
const API_KEY = "sk_live_xxxxx"; // PROIBIDO

// âœ… Use variÃ¡veis de ambiente server-side
// .env.local (NUNCA commitar)
STRIPE_SECRET_KEY=sk_live_xxxxx

// Server Component/API Route
const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!);
````

---

**IMPORTANTE:** Estas regras sÃ£o INEGOCIÃVEIS. Qualquer violaÃ§Ã£o deve ser justificada em comentÃ¡rio de cÃ³digo ou ADR.