---
description: "TikTok API, Shadowban, AIGC Disclosure"
globs:
  - "src/lib/integrations/tiktok/**"
  - "src/infrastructure/integrations/tiktok/**"
  - "**/tiktok*.ts"
---

# üéµ INTEGRA√á√ÉO TIKTOK CONTENT POSTING API

## Risco: Shadowban e Redu√ß√£o de Alcance

### Contexto
V√≠deos postados via API t√™m alcance 30-70% menor que posts manuais SE n√£o seguirem boas pr√°ticas.

## Estrat√©gia "Human-Hybrid" (OBRIGAT√ìRIA)
````typescript
// ‚úÖ PADR√ÉO: Enviar como DRAFT, n√£o Direct Post
async function postToTikTok(videoData: VideoData, userId: string) {
  const response = await tiktokClient.post('/v2/post/publish/video/init/', {
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      post_info: {
        title: videoData.title,
        privacy_level: 'SELF_ONLY', // ‚ö†Ô∏è Draft mode
        disable_duet: false,
        disable_comment: false,
        disable_stitch: false,
        video_cover_timestamp_ms: 1000,
      },
      source_info: {
        source: 'FILE_UPLOAD',
        video_url: videoData.uploadUrl,
      },
      post_mode: 'DIRECT_POST', // Ou 'CREATOR_UPLOAD'
      media_type: 'VIDEO',
      // üö® OBRIGAT√ìRIO: Marcar IA
      is_aigc: true, // AI-generated content disclosure
    }),
  });

  // Notificar usu√°rio para publicar manualmente
  await sendPushNotification(userId, {
    title: 'Seu v√≠deo est√° pronto no TikTok!',
    body: 'Adicione um sticker ou √°udio trending para maximizar alcance',
    action: 'OPEN_TIKTOK_DRAFTS',
  });

  return response;
}
````

## Algoritmo de Jitter (Anti-Detec√ß√£o)
````typescript
// ‚úÖ Adicionar varia√ß√£o aleat√≥ria nos agendamentos
function scheduleWithJitter(scheduledTime: Date): Date {
  const JITTER_RANGE = 15 * 60 * 1000; // ¬±15 minutos em ms
  const jitter = Math.random() * JITTER_RANGE * 2 - JITTER_RANGE;
  
  return new Date(scheduledTime.getTime() + jitter);
}

// Uso
const scheduledTime = new Date('2026-01-20T14:00:00Z');
const actualTime = scheduleWithJitter(scheduledTime);
// Resultado: algo entre 13:45 e 14:15 (aleat√≥rio)
````

## Compliance: Marca√ß√£o Obrigat√≥ria de IA
````typescript
// üö® CR√çTICO: Flag is_aigc √© OBRIGAT√ìRIA para conte√∫do IA
const postPayload = {
  post_info: {
    title: videoData.title,
    privacy_level: videoData.isPublic ? 'PUBLIC_TO_EVERYONE' : 'SELF_ONLY',
  },
  // ‚ö†Ô∏è NUNCA omitir esta flag
  is_aigc: true, // AI-generated content disclosure
  
  // Se for conte√∫do comercial/promocional
  disclose_commercial_content: videoData.isCommercial || false,
};

// ‚ùå Omitir is_aigc pode resultar em:
// - Redu√ß√£o de alcance de at√© 73%
// - Remo√ß√£o do v√≠deo
// - Suspens√£o da API
````

## Auditoria de Aplica√ß√£o (Para Modo P√∫blico)
````typescript
// ‚ö†Ô∏è Apps n√£o-auditados s√≥ podem postar em modo PRIVADO
// Para permitir postagem p√∫blica, o app deve passar por auditoria

const AUDIT_REQUIREMENTS = `
Para solicitar auditoria do TikTok:

1. ‚úÖ Aplica√ß√£o funcional com hist√≥rico de uploads
2. ‚úÖ Pol√≠tica de Privacidade p√∫blica
3. ‚úÖ Termos de Uso claros
4. ‚úÖ Funcionalidades OBRIGAT√ìRIAS na UI:
   - Usu√°rio DEVE poder escolher privacidade (n√£o pode ser padr√£o)
   - Usu√°rio DEVE poder habilitar/desabilitar coment√°rios
   - Usu√°rio DEVE poder habilitar/desabilitar duetos/stitch
5. ‚úÖ PROIBIDO adicionar marcas d'√°gua autom√°ticas
6. ‚úÖ PROIBIDO adicionar links promocionais no v√≠deo

Processo:
- Acesse TikTok Developer Portal
- Submit app para Content Posting API Review
- Aguarde 2-4 semanas
- Demonstre casos de uso leg√≠timos
`;
````

## Rate Limiting
````typescript
// ‚úÖ Limites da API (por usu√°rio)
const TIKTOK_LIMITS = {
  videosPerDay: 20, // Limite conservador
  videosPerWeek: 100,
  maxVideoSize: 4 * 1024 * 1024 * 1024, // 4GB
  maxDuration: 10 * 60, // 10 minutos (em segundos)
};

async function canPostToTikTok(userId: string): Promise<boolean> {
  const today = new Date();
  today.setHours(0, 0, 0, 0);

  const postsToday = await prisma.tiktokPost.count({
    where: {
      user_id: userId,
      created_at: {
        gte: today,
      },
    },
  });

  return postsToday < TIKTOK_LIMITS.videosPerDay;
}
````

## Restri√ß√µes de Conte√∫do
````typescript
// ‚úÖ Validar antes de upload
function validateTikTokVideo(videoData: VideoData): ValidationResult {
  const errors: string[] = [];

  // Dura√ß√£o
  if (videoData.duration > TIKTOK_LIMITS.maxDuration) {
    errors.push(`Video too long. Max: ${TIKTOK_LIMITS.maxDuration}s`);
  }

  // Tamanho
  if (videoData.fileSize > TIKTOK_LIMITS.maxVideoSize) {
    errors.push(`File too large. Max: 4GB`);
  }

  // √Åudio
  if (videoData.hasProtectedAudio) {
    errors.push('Video contains copyrighted audio. Use TikTok Sound Library.');
  }

  // Marca d'√°gua
  if (videoData.hasWatermark) {
    errors.push('Remove watermarks before uploading.');
  }

  return {
    valid: errors.length === 0,
    errors,
  };
}
````

---

**IMPORTANTE:**
- Priorizar Draft Mode para preservar alcance
- is_aigc √© OBRIGAT√ìRIO
- Jitter aleat√≥rio em agendamentos
- Auditoria necess√°ria para modo p√∫blico