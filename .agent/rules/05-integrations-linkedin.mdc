---
description: Regras para integra√ß√£o com LinkedIn API, Warm-up, OAuth (Auth, Posts, Rate Limits)
globs: src/lib/integrations/linkedin/**/*
---
# üëî INTEGRA√á√ÉO LINKEDIN

## Contexto/Princ√≠pios
A API do LinkedIn (v2/UGC) √© rigorosa quanto a tokens e spam. O projeto Amuri usa o modelo BYOK (Bring Your Own Key).
- **Token Expiration**: Access Tokens expiram em 60 dias e exigem re-autentica√ß√£o manual do usu√°rio (Refresh tokens program√°ticos s√£o limitados a parceiros).
- **Warm-up**: Contas novas n√£o devem postar massivamente para evitar bloqueios.
- **Protocolo**: Sempre use `urn:li:person:{id}` ou `urn:li:organization:{id}` para identifica√ß√£o.

## Implementa√ß√£o

### Autentica√ß√£o e Refresh
```typescript
// ‚úÖ CORRETO: Verifica√ß√£o proativa de expira√ß√£o do token
export async function checkLinkedInTokenStatus(userId: string): Promise<Result<void>> {
  const credentials = await getEncryptedCredentials(userId, 'linkedin');
  const now = new Date();
  const expiryDate = new Date(credentials.expiresAt);
  
  // Alerta 7 dias antes de expirar
  const daysUntilExpiry = differenceInDays(expiryDate, now);
  
  if (daysUntilExpiry <= 0) {
    return Result.fail('Token LinkedIn expirado. Por favor, reconecte sua conta.');
  }
  
  if (daysUntilExpiry <= 7) {
    await notifyUser(userId, 'linkedin_token_expiring');
  }
  
  return Result.ok();
}
```

### Postagem UGC (User Generated Content)
```typescript
// ‚úÖ CORRETO: Estrutura UGC Post padr√£o com tratamento de erros
async function postToLinkedIn(
  authorUrn: string, 
  text: string, 
  accessToken: string
): Promise<Result<string>> {
  try {
    const response = await fetch('https://api.linkedin.com/v2/ugcPosts', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${accessToken}`,
        'X-Restli-Protocol-Version': '2.0.0', // ‚ö†Ô∏è CR√çTICO
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        author: authorUrn,
        lifecycleState: 'PUBLISHED',
        specificContent: {
          'com.linkedin.ugc.ShareContent': {
            shareCommentary: { text },
            shareMediaCategory: 'NONE',
          },
        },
        visibility: {
          'com.linkedin.ugc.MemberNetworkVisibility': 'PUBLIC',
        },
      }),
    });

    if (response.status === 429) {
      return Result.fail('LinkedIn Rate Limit atingido. Tente novamente mais tarde.');
    }
    
    // ... handling
  } catch (error) {
    return Result.fail(error.message);
  }
}
```

### ‚ùå ERRADO: Anti-padr√µes comuns
```typescript
// ‚ùå N√£o tente usar refresh tokens sem ser parceiro de marketing
// ‚ùå N√£o esque√ßa o header X-Restli-Protocol-Version
// ‚ùå N√£o fa√ßa hardcode do URN prefix (person vs organization)
const urn = `urn:li:person:${id}`; // Errado se for Company Page
```

## Edge Cases / Alertas
- ‚ö†Ô∏è **Imagens/V√≠deo**: Exigem um fluxo de 3 passos (Register -> Upload -> Create Post). N√£o tente enviar bin√°rios direto no UGC Post.
- ‚ö†Ô∏è **Rate Limits**: Variam baseados no SSI (Social Selling Index) e idade da conta. Implemente backoff agressivo.
- üö® **Duplicate Content**: O LinkedIn rejeita posts id√™nticos em curto per√≠odo. Adicione jitter ou varia√ß√£o no texto.
