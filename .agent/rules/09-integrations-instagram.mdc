---
description: Regras para integra√ß√£o com Instagram Graph API (Reels, Stories, Feed)
globs: src/lib/integrations/instagram/**/*
---
# üì∏ INTEGRA√á√ÉO INSTAGRAM

## Contexto/Princ√≠pios
Utiliza a Instagram Graph API (via Facebook Login). Complexidade alta devido ao processamento ass√≠ncrono de m√≠dia.
- **Account Type**: Apenas contas "Business" ou "Creator" s√£o suportadas via API. Contas pessoais n√£o funcionam.
- **Async Media**: V√≠deos (Reels) exigem polling de `container_status` antes da publica√ß√£o.
- **Rate Limits**: Limites rigorosos de ~25 posts/dia para evitar bloqueios de API.
- **Audio**: Direitos autorais s√£o checados no upload.

## Implementa√ß√£o

### Upload de Reels (Container + Publishing)
```typescript
// ‚úÖ CORRETO: Fluxo de 3 etapas com Polling
async function publishReel(
  igUserId: string, 
  videoUrl: string, 
  caption: string, 
  accessToken: string
): Promise<Result<string>> {
  // 1. Criar Container
  const containerResp = await fetch(
    `https://graph.facebook.com/v19.0/${igUserId}/media?media_type=REELS&video_url=${encodeURIComponent(videoUrl)}&caption=${encodeURIComponent(caption)}&access_token=${accessToken}`,
    { method: 'POST' }
  );
  const { id: containerId } = await containerResp.json();

  // 2. Polling de Status (Wait for FINISHED)
  let status = 'IN_PROGRESS';
  let attempts = 0;
  
  while (status !== 'FINISHED' && attempts < 20) {
    await sleep(5000); // Wait 5s
    const statusResp = await fetch(
      `https://graph.facebook.com/v19.0/${containerId}?fields=status_code&access_token=${accessToken}`
    );
    const statusData = await statusResp.json();
    status = statusData.status_code;
    
    if (status === 'ERROR') return Result.fail('Erro no processamento do v√≠deo pelo Instagram');
    attempts++;
  }

  if (status !== 'FINISHED') return Result.fail('Timeout no processamento do v√≠deo');

  // 3. Publicar Container
  const publishResp = await fetch(
    `https://graph.facebook.com/v19.0/${igUserId}/media_publish?creation_id=${containerId}&access_token=${accessToken}`,
    { method: 'POST' }
  );
  
  const publishData = await publishResp.json();
  return Result.ok(publishData.id);
}
```

### ‚ùå ERRADO: Anti-padr√µes
```typescript
// ‚ùå Tentar publicar imagem em endpoint de v√≠deo
// ‚ùå N√£o checar o status do container antes de publicar (resulta em erro gen√©rico)
// ‚ùå Usar URLs de v√≠deo que expiram r√°pido (ex: S3 presigned url com 5min)
```

## Edge Cases / Alertas
- ‚ö†Ô∏è **Aspect Ratio**: Reels devem ser 9:16. Feed pode ser 1:1 ou 4:5. A API rejeita propor√ß√µes incorretas.
- ‚ö†Ô∏è **Stories**: A API suporta publica√ß√£o de stories, mas stickers/links interativos s√£o limitados.
- üö® **Token de P√°gina**: √â necess√°rio o Page Access Token conectado √† conta Instagram, n√£o o User Token.
- üö® **Copyright**: Se o v√≠deo contiver √°udio comercial n√£o licenciado, o post pode ser publicado mas silenciado ou removido.
