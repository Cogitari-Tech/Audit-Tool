---
description: Regras globais de seguran√ßa, criptografia e compliance (LGPD/GDPR)
alwaysApply: true
globs: **/*
---
# üõ°Ô∏è SEGURAN√áA E COMPLIANCE

## Contexto/Princ√≠pios
Como uma plataforma SaaS que armazena credenciais de terceiros (BYOK), seguran√ßa √© a prioridade zero.
- **Encryption**: AES-256-GCM para todas as chaves de API e tokens.
- **Privacy**: Compliance total com LGPD (Brasil) e GDPR (Europa).
- **Sanitization**: Zero trust para inputs de usu√°rio (Zod validation).

## Implementa√ß√£o

### Criptografia de Credenciais (BYOK)
```typescript
// ‚úÖ CORRETO: AES-256-GCM com IV √∫nico
import { createCipheriv, randomBytes } from 'crypto';

const ALGORITHM = 'aes-256-gcm';
const MASTER_KEY = Buffer.from(process.env.ENCRYPTION_KEY, 'hex'); // 32 bytes

export function encryptCredential(text: string): { iv: string, content: string, tag: string } {
  const iv = randomBytes(16);
  const cipher = createCipheriv(ALGORITHM, MASTER_KEY, iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  return {
    iv: iv.toString('hex'),
    content: encrypted,
    tag: cipher.getAuthTag().toString('hex')
  };
}
```

### Consentimento de Cookies (Bloqueante)
```typescript
// ‚úÖ CORRETO: S√≥ carregar scripts ap√≥s consentimento expl√≠cito
export function AnalyticsProvider({ children }) {
  const { consent } = useCookieConsent();
  
  useEffect(() => {
    if (consent === 'granted') {
      loadGoogleAnalytics();
      loadHotjar();
    }
  }, [consent]);

  return <>{children}</>;
}
```

### Sanitiza√ß√£o de Inputs (Zod)
```typescript
// ‚úÖ CORRETO: Validar e limpar inputs na borda
const UserProfileSchema = z.object({
  bio: z.string()
    .max(500)
    .transform((val) => DOMPurify.sanitize(val)), // Previne XSS
  website: z.string().url().optional()
});
```

## Edge Cases / Alertas
- ‚ö†Ô∏è **CDC Art. 49**: Para clientes brasileiros, garantir bot√£o de "Cancelar Assinatura/Arrependimento" vis√≠vel e funcional (7 dias).
- ‚ö†Ô∏è **Logs**: NUNCA logar tokens, senhas ou PII (Personal Identifiable Information) no console ou Sentry. Use mascaramento.
- üö® **Fingerprinting**: Implementar detec√ß√£o b√°sica de abuso (mesmo IP criando 50 contas) usando Redis rate limiting na rota de signup.
