#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ›¡ï¸  Running Pre-Commit Security & Lint Checks..."

# 1. Enforce strict lint-staged (which includes security-scan)
npx lint-staged
if [ $? -ne 0 ]; then
  echo "ğŸš¨ Pre-commit failed: lint-staged errors."
  exit 1
fi

# 2. Hard block for known secrets in diff
if git diff --cached --name-only | xargs grep -iE 'SUPABASE_SERVICE_ROLE_KEY|GITHUB_TOKEN'; then
  echo "ğŸš¨ CRITICAL: Possible high-level secrets detected in staged files!"
  echo "Commit rejected. Please remove credentials (e.g., SUPABASE_SERVICE_ROLE_KEY) before committing."
  exit 1
fi

# 3. Hard block for .env files being committed
if git diff --cached --name-only | grep -E '^\.env(\..+)?$' | grep -v '\.example$'; then
  echo "ğŸš¨ CRITICAL: Attempting to commit a .env file!"
  echo "Commit rejected to prevent credential leaks."
  exit 1
fi

echo "âœ… Pre-commit verification passed."
